/**
** This file will be used for most of the functionality in singlecheckout page.
**/

/** Begin: Initialize required dojo scripts **/
dojo.require("wc.render.common");
dojo.require("dojo.cookie");
dojo.require("dojo.date");
/** End: Initialize required dojo scripts **/

/** Begin: Ajax Refresh Context Declaration **/

// Refresh context for area - User Details ( Billing Address )
wc.render.declareContext("guestCheckoutLogonAreaContext", {orderId:""},"");
wc.render.declareContext("userDetailsAreaContext", {orderId:""},"");
// Refresh Context for area - Shipping Details
wc.render.declareContext("shippingDetailsAreaContext", {orderId:"",userEmail:"",guestRUT:"",regUserRUT:"","bill_to_address_id":""},"");
wc.render.declareContext("shippingAddressAreaAddEditContext", {orderId:"",addressId:"",type:""},"");
wc.render.declareContext("shippingAddressListContext", {orderId:"",addressId:"",updateOrderItem:false},"");
wc.render.declareContext("orderItemDetailsAreaContext", {orderId:"",source:""},"");
wc.render.declareContext("selectPhysicalStoreAreaContext", {orderId:""},"");
wc.render.declareContext("selectPhysicalOfficeAreaContext", {orderId:""},"");
wc.render.declareContext("selectedPhysicalStoreAreaContext", {orderId:"",addressId:"",zona:""},"");
wc.render.declareContext("selectedPhysicalCEStoreAreaContext", {orderId:"",addressId:"",region:""},"");
wc.render.declareContext("NoviosSearchFormContext", {orderId:""},"");
wc.render.declareContext("selectedNoviosAddressAreaContext", {orderId:"",addressId:""},"");
wc.render.declareContext("noviosSearchResultsAreaContext", {orderId:""},"");
// Refresh Context for area - Payment Details
wc.render.declareContext("paymentDetailsAreaContext", {orderId:""},"");
wc.render.declareContext("NoviosSearchFormModalContext", {orderId:""},"");
wc.render.declareContext("FacturaFormModalAreaContext", {orderId:""},"");
/** End: Ajax Refresh Context Declaration **/

/** Begin: Ajax Refresh controller Declaration **/
//Refresh Controller for User Info Area (Step 1 - checkout logon) - will be used when guest user click on adding factura address
wc.render.declareRefreshController({
    id: "guestCheckoutLogonAreaController",
    renderContext: wc.render.getContextById("guestCheckoutLogonAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;           
        // Hide step 1 - Billing address, step 2 and step 3
        if(dojo.byId('checkout_billing_address')){
        	dojo.byId('checkout_billing_address').className = "hide";
        }
        displayCheckoutArea('checkout_userdetails','enable');
        // This is only for guest user
		dojo.query('#checkout_userdetails .EditSection')[0].className="EditSection hide";
		
        // Hide the edit and delivery test from step 2 header
        dojo.query('#checkout_orderdetails .EditSection')[0].className="EditSection hide";
        dojo.query('#checkout_orderdetails .shipping_text')[0].className="shipping_text hide";        
        displayCheckoutArea('checkout_orderdetails','editlogon');
        
        dojo.byId('checkout_billingdetails').className = "";        
        displayCheckoutArea('checkout_billingdetails','editlogon');
        
        // GTM: Data layer
        if(dataLayer){
        	dataLayer.push({
        		'event' :'fireRemarketingLoginCheckout'
        	});
        }
    }
})

// Refresh Controller for User Info Area (Step 1 - Billing Address)
wc.render.declareRefreshController({
    id: "userDetailsAreaController",
    renderContext: wc.render.getContextById("userDetailsAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;           
        // Hide Guest Checkout Logon Area
        if(dojo.byId('checkout_guest')){
        	dojo.byId('checkout_guest').style.display = "none";   
        }		   
        
        // This is only for guest user
		dojo.query('#checkout_userdetails .EditSection')[0].className="EditSection hide";			
        
        // Select default identify - RUT
        selectGuestIdentity();
        var isEditBillAddress = renderContext.properties['refreshBillingAddress'];
        if(null != isEditBillAddress && undefined != isEditBillAddress && isEditBillAddress){
	        // Hide Step 3, step 2
			displayCheckoutArea('checkout_userdetails','enable');
							        
			// Hide the edit and delivery text from the step header
			dojo.query('#checkout_orderdetails .EditSection')[0].className="EditSection hide";
			dojo.query('#checkout_orderdetails .shipping_text')[0].className="shipping_text hide";
	        displayCheckoutArea('checkout_orderdetails','editlogon');
	        
	        dojo.byId('checkout_billingdetails').className = "";        
	        displayCheckoutArea('checkout_billingdetails','editlogon');	
	        
	        // Pre select the RUT | DNI option based on the user's selection
	        if(dojo.byId('checkout_billing_addressfield1')){
	        	var field1value = dojo.byId('checkout_billing_addressfield1').value;
	        	if("" != field1value && field1value == 'DNI'){
	        		dojo.byId('checkout_billing_option_dni').checked = true;
	        	}else {
	        		dojo.byId('checkout_billing_option_rut').checked = true;
	        	}
	        	
	        }
        }
        
    }
})

// Refresh area for Shipping Details (Step 2 - Main)
wc.render.declareRefreshController({
    id: "shippingDetailsAreaController",
    renderContext: wc.render.getContextById("shippingDetailsAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext; 
        
        // GTM: Data layer
        if(dataLayer){
        	dataLayer.push({
        		'event' :'fireRemarketingEntrega'
        	});
        }
        
        // Disable Step1: the user info Billing Address	
        displayCheckoutArea('checkout_userdetails','disable');
		// Enable Step2:
        displayCheckoutArea('checkout_orderdetails','enable');
        // If Ship address form loaded by default, load the communa for respective region
        if(dojo.byId('checkout_shipping_city')){
        	SinglePageCheckoutJS.loadCommunes('ShipAddressForm','checkout_shipping_city');
        }
        // If Edit link is opened hide it
        dojo.query('#checkout_orderdetails .EditSection')[0].className="EditSection hide";
        dojo.query('#checkout_orderdetails .shipping_text')[0].className="shipping_text hide";
        // Initialize the dojo refresh area in shipping details section
        initShippingDetailsRefreshArea();
        
        var selectedNoviosCode = renderContext.properties['selectedNoviosCode'];
        if(null != selectedNoviosCode && "" != selectedNoviosCode){
        	// Refresh the novios details area
        	wc.render.updateContext("selectedNoviosAddressAreaContext",{"orderId":SinglePageCheckoutJS.orderId,"selectedNoviosCode":selectedNoviosCode});
        
        }else{
        	// Hide the progressbar
            removeProgressBar();                       
        
	        // Enable edit button of billing address area
	        if(dojo.byId('regUserType') && dojo.byId('regUserType').value == 'G'){
	        	dojo.query('#checkout_userdetails .EditSection')[0].className="EditSection show";
	        }        
	        
	        // If any EOM allocation message, display to user.
	        if(null != renderContext.properties['failedAllocation'] && "" != renderContext.properties['failedAllocation']){
	        	CheckoutModalJS.showModal(renderContext.properties['failedAllocation']);
	        	renderContext.properties['failedAllocation'] = "";
	        }
	      
	        /*Code for all tabs closed for default */
	
	        if(window.matchMedia && window.matchMedia('only screen and (min-width: 320px) and (max-width: 1024px)').matches){
	            var clickEvent = document.createEvent ('MouseEvents');
	            clickEvent.initEvent ('click', true, true);
	            if(dojo.byId('AccordionDespachoMo')){
	                dojo.byId('AccordionDespachoMo').dispatchEvent (clickEvent);       
	            }
	        }
	        AnchorScroll('#checkout_orderdetails');
	        
        }
         
    }
})

// Refresh area for add/edit shipping address (Step 2 - Despacho)
wc.render.declareRefreshController({
    id: "shippingAddressAreaAddEditController",
    renderContext: wc.render.getContextById("shippingAddressAreaAddEditContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        // Load the communa
        SinglePageCheckoutJS.loadCommunes('ShipAddressForm','checkout_shipping_city');
        // Open the form as a model
        unloadScrollBars();
        
        // Mapcity
        //CheckoutAddressHelper.drawMapCity();
        //setTimeout("CheckoutAddressHelper.modalOnLoadChecking()", 1000);
        
        dojo.byId('add_edit_address').className = "show";
        dojo.byId("checkoutShippingAddressForm").className = "ModalDesktop";
        dojo.byId("shippingAddressFormContainer").className = "modal-contenido";
        dojo.byId("imgCerrar").className = "CerrarIcono";
        //dojo.byId("heading_close").classList.remove('OcultaHeader');
        dojo.removeClass(dojo.byId("heading_close"), 'OcultaHeader');
        //dojo.byId("shipAddress_desc").classList = ('OcultaHeader');
        dojo.addClass(dojo.byId("shipAddress_desc"),'OcultaHeader');
           
    }
})

// Refresh area to display list of Shipping Address (Step 2 - Despacho) 
wc.render.declareRefreshController({
    id: "shippingAddressListController",
    renderContext: wc.render.getContextById("shippingAddressListContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        
        // Disable the Add/Edit address area in order to show the list of address
        if(dojo.byId('add_edit_address')){
        	dojo.byId('add_edit_address').className = "hide";
        }
        
        // Recalculate the order with selected address id and display the order item details
        if(renderContext.properties['updateOrderItem']){
        	SinglePageCheckoutJS.updateAddressIdForAllItems(renderContext.properties['addressId']);
        }
        // reset to false
        renderContext.properties['updateOrderItem'] = false;
    }
})

// Refresh area to display order item details (Step 2 - Common for Despacho,ReT,Novios)
wc.render.declareRefreshController({
    id: "orderItemDetailsAreaController",
    renderContext: wc.render.getContextById("orderItemDetailsAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;
        renderContext.properties['source'] = SinglePageCheckoutJS.selectedDeliveryOption; 
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;                    
        
        // display the grouping if it is disabled in other steps
        dojo.byId('checkout_orderitem_groups').className = "show";
        // hide the continue despacho button for single ship address scenario
        if(dojo.byId('checkout_ship_address_continue')){
        	dojo.byId('checkout_ship_address_continue').className = "hide";
        }
        
        // Update the group ship date for ReT(Retiro En Tienda) If current selection is ReT.
        if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabRetiroEnTienda' && dojo.byId('ret_group_ship_date')){        	
        	dojo.byId('ret_firstAvailableDate').innerHTML = dojo.byId('ret_address_ship_date_text').value + '<strong>' + dojo.byId('ret_group_ship_date').value + '</strong>';
        	dojo.byId('ret_contingencyDate').className = 'hide';
        	dojo.byId('ret_firstAvailableDate').className = 'show';        	
        } else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabRetiroEnTienda'){
        	dojo.byId('ret_contingencyDate').className = 'show';
        	dojo.byId('ret_firstAvailableDate').className = 'hide';
        } else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabChileExpress'){
        	dojo.byId('ce_contingencyDate').className = 'hide';
        	dojo.byId('ce_firstAvailableDate').className = 'hide';
        }else if(SinglePageCheckoutJS.selectedDeliveryOption == "TabDespacho" && document.getElementsByName('select_ship_address')){
        	dojo.query('input[type=radio][name=select_ship_address]').forEach(function(element){
        		if(element.checked){
        			element.disabled = true;
        		}else{
        			element.disabled = false;
        		}
        	});
        }                
        
        // To Hide the progress Bar
		removeProgressBar();
		
		// Reset other shipping options to default
        SinglePageCheckoutJS.resetShippingDetails();
        
        // If any orderitems deleted in step2 from Delete option,EOM Exception Modal, refresh physicalstorelist jsp to recalculate the valid CC orderitems
        if(dojo.byId('checkoutReTForm')){        	     
	        if(dojo.byId('totalNumberOfItems') && SinglePageCheckoutJS.totalOrderItems == ""){
	        	SinglePageCheckoutJS.totalOrderItems = dojo.byId('totalNumberOfItems').value;
	        }else if(dojo.byId('totalNumberOfItems') && SinglePageCheckoutJS.totalOrderItems != ""
	        	&& SinglePageCheckoutJS.totalOrderItems != dojo.byId('totalNumberOfItems').value){
	        	
	        	// Refresh the valid cc orderitems list
	        	if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabRetiroEnTienda'){
	        		wc.render.updateContext("selectPhysicalStoreAreaContext",{"orderId":SinglePageCheckoutJS.orderId, "totalOrderItems":dojo.byId('totalNumberOfItems').value, "hide":"hide"});
	        	}else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabChileExpress'){
	        		wc.render.updateContext("selectPhysicalOfficeAreaContext",{"orderId":SinglePageCheckoutJS.orderId, "totalOrderItems":dojo.byId('totalNumberOfItems').value, "hide":"hide"});
	        	}
	        }
        }
        if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabNovio'){ 
            AnchorScroll("#novios_address_details");
        }
        if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabRetiroEnTienda'){
            AnchorScroll("#checkout_ret_detail_head");
        }
        if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabDespacho'){
            AnchorScroll("#shipping_order_details");
        }
        if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabChileExpress'){
            AnchorScroll("#checkout_ce_detail_head");
        }
    }
})

// Refresh area to display select physical store section
wc.render.declareRefreshController({
    id: "selectPhysicalStoreAreaController",
    renderContext: wc.render.getContextById("selectPhysicalStoreAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        
        // Reset the total orderitem
        SinglePageCheckoutJS.totalOrderItems = renderContext.properties['totalOrderItems'];
        if(SinglePageCheckoutJS.selectedDeliveryOption != "TabRetiroEnTienda"){
        	dojo.byId('checkoutReTForm').className = "show";
        }
        // If no valid cc order items in the order, switch to DaD and hide the ReT option
        if(dojo.byId('validCCOrderItems') && dojo.byId('validCCOrderItems').value == ""){        
        	var clickEvent = document.createEvent ('MouseEvents');
			clickEvent.initEvent ('click', true, true);
			if(dojo.byId('UnselectedTabDespacho'))
				dojo.byId('UnselectedTabDespacho').dispatchEvent (clickEvent);
			if(dojo.query('.tablinks')[0])
				dojo.query('.tablinks')[0].dispatchEvent (clickEvent);
						  
			dojo.destroy(dojo.query('.tablinks')[1]);
			dojo.destroy(dojo.query('#AccordionRetiro')[0]);
			dojo.destroy(dojo.query('#UnselectedRetiro2')[0]);
			dojo.destroy(dojo.query('#UnselectedRetiro')[0]);
        }
        
    }
})

// 1148 Refresh area to display select physical Office section
wc.render.declareRefreshController({
    id: "selectPhysicalOfficeAreaController",
    renderContext: wc.render.getContextById("selectPhysicalOfficeAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        
        // Reset the total orderitem
        SinglePageCheckoutJS.totalOrderItems = renderContext.properties['totalOrderItems'];
        if(SinglePageCheckoutJS.selectedDeliveryOption != "TabChileExpress"){
        	dojo.byId('checkoutCEForm').className = "show";
        }
        // If no valid ce order items in the order, switch to DaD and hide the ReT option
        if(dojo.byId('validCEOrderItems') && dojo.byId('validCEOrderItems').value == ""){        
        	var clickEvent = document.createEvent ('MouseEvents');
			clickEvent.initEvent ('click', true, true);
			if(dojo.byId('UnselectedTabDespacho'))
				dojo.byId('UnselectedTabDespacho').dispatchEvent (clickEvent);
			if(dojo.query('.tablinks')[0])
				dojo.query('.tablinks')[0].dispatchEvent (clickEvent);
						  
			dojo.destroy(dojo.query('.tablinks')[1]);
			dojo.destroy(dojo.query('#AccordionRetiro')[0]);
			dojo.destroy(dojo.query('#UnselectedRetiro2')[0]);
			dojo.destroy(dojo.query('#UnselectedRetiro')[0]);
        }
        
    }
})

// Refresh area to display selected physical store and proxy pickup details
wc.render.declareRefreshController({
    id: "selectedPhysicalStoreAreaController",
    renderContext: wc.render.getContextById("selectedPhysicalStoreAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        // Hide the physical store address drop down and display the selected store address.
        if(dojo.byId('checkoutReTForm')){
        	dojo.byId('checkoutReTForm').className = "hide";
        }
        // fetch the seletec store address details from the array
        var selectedAddressId = renderContext.properties['addressId'];
        var selectedZona = renderContext.properties['zona'];
        for(store in zonaStores[selectedZona].stores){
        	if(selectedAddressId == zonaStores[selectedZona].stores[store].addressId){
        		var address = zonaStores[selectedZona].stores[store].address;
        		var selectedStore = zonaStores[selectedZona].stores[store].name;
        	}
        }       
        // display the address
        dojo.byId('ret_selected_address').innerHTML = address;         
        // display the store name.
        dojo.byId('ret_store_name').innerHTML = dojo.byId('ret_store_label').value + selectedStore;
        // Recalculate the order with selected address id and display the order item details        
        SinglePageCheckoutJS.updateAddressIdForAllItems(renderContext.properties['addressId']);
        
        // Show / hide the proxy pickup details
        if(dojo.byId('proxyPickUpAddressId')){
        	// If exists, means order has already proxy pickup details
        	dojo.byId('proxy_checkbox').checked = true;
        	dojo.byId('proxypickup_content').className = "show";
        }else{
        	// no proxy pickup address
        	dojo.byId('proxy_checkbox').checked = false;
        	dojo.byId('proxypickup_content').className = "hide";
        }
        
           
    }
})

// 1148 Refresh area to display selected physical region and office details
wc.render.declareRefreshController({
    id: "selectedPhysicalCEStoreAreaController",
    renderContext: wc.render.getContextById("selectedPhysicalCEStoreAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        // Hide the physical store address drop down and display the selected store address.
        if(dojo.byId('checkoutCEForm')){
        	dojo.byId('checkoutCEForm').className = "hide";
        }
        // fetch the seletec store address details from the array
        var selectedAddressId = renderContext.properties['addressId'];
        var selectedRegion = renderContext.properties['region'];
        for(cestore in officeStores[selectedRegion].cestores){
        	if(selectedAddressId == officeStores[selectedRegion].cestores[cestore].addressId){
        		var address = officeStores[selectedRegion].cestores[cestore].address;
        		var selectedCEStore = officeStores[selectedRegion].cestores[cestore].name;
        	}
        }       
        // display the address
        dojo.byId('ce_selected_address').innerHTML = address;         
        // display the store name.
        dojo.byId('ce_office_name').innerHTML = dojo.byId('ce_office_label').value + selectedCEStore;
        // Recalculate the order with selected address id and display the order item details        
        SinglePageCheckoutJS.updateAddressIdForAllItems(renderContext.properties['addressId']);
    }
})

// Refresh area for Payment Details (Step 3)
wc.render.declareRefreshController({
    id: "paymentDetailsAreaController",
    renderContext: wc.render.getContextById("paymentDetailsAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;    
        renderContext.properties['source'] = SinglePageCheckoutJS.selectedDeliveryOption;
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        

        // GTM: Data layer
        if(dataLayer){
        	dataLayer.push({
        		'event' :'fireRemarketingTagPago'
            });
        }
        
        // Hide the step 2 and show the step 3
		// Disable Step2: the user info Billing Address	
        displayCheckoutArea('checkout_orderdetails','disable');
		// Enable Step3:
        displayCheckoutArea('checkout_billingdetails','enable');
        
        dojo.byId('checkout_billingdetails').className = "open";
        
        // Enable the edit link for step 2:
        dojo.query('#checkout_orderdetails .EditSection')[0].className="EditSection show";
        
        // Enable the edit link for step 1: Payment error flow:
        if(renderContext.properties['errorReason']){        	
        	dojo.query('#checkout_userdetails .EditSection').forEach(function(elem){
				elem.className="EditSection show";
			})
        }        
        
        // Tab Click event in payment section
        $('.accordion-title').click(function () {
            
            var ocultar=0;
            if ($(this).hasClass('active')) {
                ocultar=1;
            }  

            var clickedID = this.id;
            $(".accordion-title" ).each(function( index ) {
                $('.accordion-title').removeClass('active');
                $(this).removeClass('active').next('.accordion-content').slideUp();
                setTimeout(function(){
                 $('.accordion-title').removeClass('RemoveLine');
                }, 200);
            });

            if(ocultar==0){
                $(this).addClass('active').next('.accordion-content').slideDown();
                $(".accordion-title" ).each(function( index ) {
                    if ($(this).hasClass('active')) {
                        
                        setTimeout(function(){
                            var idDiv= "#"+clickedID;
                            $(idDiv).addClass('RemoveLine');                                         
                        }, 200);
                    }    
                });
                setTimeout(function(){
                    AnchorScroll("#"+clickedID);
                }, 400);
            }

           /* if (ocultar==1) {
                $(this).addClass('active').next('.accordion-content').slideDown();
                $(this).addClass('RemoveLine');
            }*/
            /*$(this).addClass('active').next('.accordion-content').slideDown();
                setTimeout(function(){
                    $(this).addClass('RemoveLine');
              
            }, 500);*/

	        /*if ($(this).hasClass('active')) {
	            $(this).removeClass('active').next('.accordion-content').slideUp();
	            setTimeout(function(){
	  					$('.accordion-title').removeClass('RemoveLine');
              
	 			 }, 500);

                //AnchorScroll("#"+clickedID);
	        } else {
	            $('.accordion-title').removeClass('active');
	            $('.accordion-content').slideUp();
	            $(this).addClass('active').next('.accordion-content').slideDown();
	            //$(this).addClass('RemoveLine');   
                $('.accordion-title').addClass('RemoveLine');

                setTimeout(function(){
                    AnchorScroll("#"+clickedID);
                }, 400);
                            
	        }*/
	    });
        
        var paymentErrorCode = renderContext.properties['errorReason'];
        var paymentErrorFopId = renderContext.properties['errorFopId'];

        // If promotion code already applied, make it visible
        var form = document.forms["PromotionCodeForm"];
        if(undefined != form && null != form && "" != form.promoCode.value){
        	dojo.query('#promotion_details .accordion-title')[0].className = "accordion-title active RemoveLine";
        	dojo.query('#promotion_details .accordion-content')[0].style.display = "block";
        }
        
        // If Giftcard applied make it visible
        var form = document.forms["GiftCardForm"];
        if(undefined != form && null != form && "" != form.giftCardNumber.value){
        	dojo.query('#giftcard_details .accordion-title')[0].className = "accordion-title active RemoveLine";
        	dojo.query('#giftcard_details .accordion-content')[0].style.display = "block";
        }

        // If Novios points applie make it visible
        var form = document.forms["NoviosCodeFormBillingPage"];
        if(undefined != form && null != form && "" != form.externalId_novios.value){
        	dojo.query('#novios_details .accordion-title')[0].className = "accordion-title active RemoveLine";
        	dojo.query('#novios_details .accordion-content')[0].style.display = "block";
		}
        // for credit card type validation must be FOP dynamic...
//		$(function() {
//	        $('#card_number_5').validateCreditCard(function(result) {
//	            $('#log_5').html('Card type: ' + (result.card_type == null ? '-' : result.card_type.name)
//	                     + '<br>Valid: ' + result.valid
//	                     + '<br>Length valid: ' + result.length_valid
//	                     + '<br>Luhn valid: ' + result.luhn_valid);
//	        });
//	    });
//		$(function() {
//	        $('#card_number_20').validateCreditCard(function(result) {
//	            $('#log_20').html('Card type: ' + (result.card_type == null ? '-' : result.card_type.name)
//	                     + '<br>Valid: ' + result.valid
//	                     + '<br>Length valid: ' + result.length_valid
//	                     + '<br>Luhn valid: ' + result.luhn_valid);
//	        });
//	    });
		
		var callback1=function(e) {
            if(e.valid){
            	if(e.card_type.name==='visa'){
            		$("#card_type_20").val('001')
            	}else if(e.card_type.name==='mastercard'){
            		$("#card_type_20").val('002')
            	}
            }
        };
        var callback2=function(e) {
            if(e.valid){
            	if(e.card_type.name==='visa'){
            		$("#card_type_99").val('001')
            	}else if(e.card_type.name==='mastercard'){
            		$("#card_type_99").val('002')
            	}else if(e.card_type.name==='amex'){
            		$("#card_type_99").val('003')
            	}
            }
        };
		if($("#card_number_20").length){
			 $("#card_number_20").validateCreditCard(callback1, {
		            accept: ["visa", "mastercard"]
		        });        
		}
		if($("#card_number_99").length){
			$("#card_number_99").validateCreditCard(callback2, {
		            accept: ["visa", "mastercard", "amex"]
		        });
		}
        // Reset the properties of this widget
        renderContext.properties = {};
        
        // Initialize Novios search modal widget  
        if(dojo.byId('CheckoutNoviosSearchFormModalURL')){
        	SinglePageCheckoutJS.setControllerURL('NoviosSearchFormModalController',dojo.byId('CheckoutNoviosSearchFormModalURL').value);
        	parseWidget("NoviosSearchFormModal");
        }
        
        // Initialize factura form modal widget
        if(dojo.byId('FacturaFormModalArea')){
        	SinglePageCheckoutJS.setControllerURL('FacturaFormModalAreaController',dojo.byId('FacturaModalDisplayViewURL').value);
        	parseWidget("FacturaFormModalArea");
        }
        
        // To Display the delivery details in step2 header section
        var shippingTextDiv = dojo.query('#checkout_orderdetails .shipping_text')[0];
        if(shippingTextDiv){        	
        	
        	// For mobile - adding additional style
        	if(SinglePageCheckoutJS.selectedDeliveryOption != ""){
        		dojo.addClass(dojo.query('#checkout_orderdetails #box_header')[0],'shippingText');
        	}
        	
	        // Despacho Domicilo Delivery
	        if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabDespacho'){
	        	// Offline Orders/Exception orders
	        	if(dojo.query('#group_shipdate .SpanCalendar.offline').length > 0){        		
	        		shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_DAD_OFFLINE_DELIVERY"];
	        	}
	        	// EOM Online - Single Group
	        	else if(dojo.query('#group_shipdate .SpanCalendar.online').length == 1){
	        		shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_DAD_SINGLE_DELIVERY"] + dojo.query('#group_shipdate .SpanCalendar.online')[0].innerHTML;
	        	}
	        	// EOM Online - Multiple Group
	        	else if(dojo.query('#group_shipdate .SpanCalendar.online').length > 1){
	        		shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_DAD_MULTIPLE_DELIVERY"];
	        	}
	        	
	        }
	        // Retiro En Tienda Delivery
	        else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabRetiroEnTienda'){
	        	// online order
	        	if(dojo.byId('ret_group_ship_date') && dojo.query('#checkoutReTDetails #ret_store_name')){
	        		shippingTextDiv.innerHTML = dojo.query('#checkoutReTDetails #ret_store_name')[0].innerHTML + ": " + dojo.byId('ret_group_ship_date').value;
	        	}
	        	// offline orders
	        	else{
	        		shippingTextDiv.innerHTML = dojo.query('#checkoutReTDetails #ret_store_name')[0].innerHTML + ": " + MessageHelper.messages["CHECKOUT_STEP2_RET_OFFLINE_DELIVERY"];
	        	}
	        }
	        // Chile Express Delivery
	        else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabChileExpress'){
	        	// online order
	        	if(dojo.byId('group_shipdate') && dojo.query('#checkoutCEDetails #ce_office_name')){
	        		shippingTextDiv.innerHTML = dojo.query('#checkoutCEDetails #ce_office_name')[0].innerHTML + " : " + dojo.query('#group_shipdate .SpanCalendar.online')[0].innerHTML;
	        	}
	        	// offline orders
	        	else{
	        		shippingTextDiv.innerHTML = dojo.query('#checkoutCEDetails #ce_office_name')[0].innerHTML + " : " + MessageHelper.messages["CHECKOUT_STEP2_RET_OFFLINE_DELIVERY"];
	        	}
	        	/*// Offline Orders/Exception orders
	        	if(dojo.query('#group_shipdate .SpanCalendar.offline').length > 0){        		
	        		shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_DAD_OFFLINE_DELIVERY"];
	        	}
	        	// EOM Online - Single Group
	        	else if(dojo.query('#group_shipdate .SpanCalendar.online').length == 1){
	        		shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_DAD_SINGLE_DELIVERY"] + dojo.query('#group_shipdate .SpanCalendar.online')[0].innerHTML;
	        	}
	        	// EOM Online - Multiple Group
	        	else if(dojo.query('#group_shipdate .SpanCalendar.online').length > 1){
	        		shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_DAD_MULTIPLE_DELIVERY"];
	        	}*/
	        }
	        // Novios Delivery
	        else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabNovio'){
	        	shippingTextDiv.innerHTML = MessageHelper.messages["CHECKOUT_STEP2_NOVIOS_DELIVERY"] + dojo.query('#novios_address .NumberNovio p')[0].innerHTML;
	        }
	        
	        // Display the text
	        dojo.query('#checkout_orderdetails .shipping_text')[0].className="shipping_text show";
        }
        
        // Hide the progress bar
        removeProgressBar();
        
        // If cybersource fraud validation error happened, expand paymentMedium which was selected by user earlier
        if(paymentErrorCode == 'CYBER_SOURCE_FRAUD_FAILED' && null != paymentErrorFopId 
        		&& dojo.trim(paymentErrorFopId) != '') {
            var clickEvent = document.createEvent ('MouseEvents');
            clickEvent.initEvent ('click', true, true);
            var errorFopId = dojo.trim(paymentErrorFopId);
            // If fop Id 99 - change to 11
            if(errorFopId == '99'){            	            
            	errorFopId = '11'
            }
            if(dojo.byId('paymentMedium_'+errorFopId)){
                dojo.query('#paymentMedium_'+ errorFopId +' .accordion-title')[0].dispatchEvent (clickEvent);       
            }

        }    
        AnchorScroll('#checkout_billingdetails');

    }
})

// Refresh area to display the selected novios address details
wc.render.declareRefreshController({
    id: "selectedNoviosAddressAreaController",
    renderContext: wc.render.getContextById("selectedNoviosAddressAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        
        // Enable edit button of billing address area
        if(dojo.byId('regUserType') && dojo.byId('regUserType').value == 'G'){
        	dojo.query('#checkout_userdetails .EditSection')[0].className="EditSection show";
        }   
        
        // Reset the step context properties
        var shippingDetailsContext = wc.render.getContextById("shippingDetailsAreaContext");
        shippingDetailsContext.properties['isNoviosShipping'] = "";
        shippingDetailsContext.properties['selectedNoviosCode'] = "";
        
        SinglePageCheckoutJS.selectedDeliveryOption = 'TabNovio';
        
        // Hide the novios search results area
		dojo.byId('select_novios_address').className = "hide";
		// show the selected novios area
		dojo.byId('checkout_novios_address_detail').className = "show";
		
		// Trigger click event on novios tab
		var clickEvent = document.createEvent ('MouseEvents');
		clickEvent.initEvent ('click', true, true);
		// Mobile
		if(window.matchMedia && window.matchMedia('only screen and (min-width: 320px) and (max-width: 1024px)').matches){
			if(dojo.byId('UnselectedNovio'))
				dojo.byId('UnselectedNovio').dispatchEvent (clickEvent);
		}
		// Desktop
		if(dojo.query('.tablinks.novios')[0])
			dojo.query('.tablinks.novios')[0].dispatchEvent (clickEvent);
		
        var codigoNovios = renderContext.properties['selectedNoviosCode'];
        // Set default addressId For Novios flow to -3
		SinglePageCheckoutJS.updateAddressIdForAllItems("-3",codigoNovios);
           
    }
})
// Refresh area to display the novios search results
wc.render.declareRefreshController({
    id: "noviosSearchResultsAreaController",
    renderContext: wc.render.getContextById("noviosSearchResultsAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;               
		
		// Clear the progress bar.
		ext_cursor_clear();
        
		/*
		 *  getting input hudden variable to display error message for below scenarios.
		 * 1) If the entered field value gives "0" results, then display the invalid message on corresponding fields.
		 * 2) If event date is Expired(eventdate < currentDate - 7 days). then display the Expired event message on corresponding fields.
		 * 3) If event date is In active(eventdate > currentDate + 90 days). then display the in active event message on corresponding fields.
		 */
		if(dojo.byId('noviosMessage')!=undefined && dojo.byId('noviosMessage').value != undefined){
			var form = dojo.byId('search_registry').name;
			var id = dojo.byId('noviosMessage').value;
			var name = dojo.byId('noviosMessage').name;
			
			if(name == 'noviosInvalid'){
				if(id == "noviosFirstName"){					
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_INVALID_NOVIOS_FIRST_NAME"];
				}else if(id == "noviosLastName"){					
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_INVALID_NOVIOS_LAST_NAME"];
				}else if(id == "externalId"){					
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_INVALID_NOVIOS_CODE"];
				}else if(id == "expiredEvent"){
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_INVALID_NOVIOS_FIELD"];
				}else if(id == "ExpiredFirstName"){
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_NOVIOS_INVALID_RESULTS"];
				}else if(id == "ExpiredLastName"){
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_NOVIOS_INVALID_RESULTS"];
				}else{
					// do nothing.
				}
			}else if(name == 'noviosInactive'){
				 if(id == "externalId"){					
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_INACTIVE_NOVIOS_CODE"];
				}else{
					// do nothing.
				}
			}else if(name == 'noviosExpire'){
				if(id == "externalId"){					
					dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_EXPIRED_NOVIOS_CODE"];
				}else{
					// do nothing.
				}
			}
			// Display the search results area with erro messages
			displayNoviosSearchResultArea('error');
			return;
		}
		// Display the novios search results area with proper results
		displayNoviosSearchResultArea('success');
        yaSimpleScrollbar.attach(document.getElementById('ContentResultNovios'));
           
    }
})

// Refresh area to display the novios serach results form in billing section
wc.render.declareRefreshController({
    id: "NoviosSearchFormModalController",
    renderContext: wc.render.getContextById("NoviosSearchFormModalContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        dojo.byId("NoviosSearchFormModal").className = "show";
        dojo.query("#NoviosSearchFormModal #checkoutNoviosddressForm")[0].className = "ModalDesktop";
        dojo.query("#NoviosSearchFormModal #noviosAddressFormContainer")[0].className = "modal-contenido";
        dojo.query("#NoviosSearchFormModal #imgCerrarNovios")[0].className = "CerrarIcono";
        dojo.removeClass(dojo.query("#NoviosSearchFormModal #heading_closeNovios")[0],'OcultaHeader');
        dojo.addClass(dojo.query("#NoviosSearchFormModal #checkout_novios_input_head")[0],'OcultaHeader');
        dojo.query('#NoviosSearchFormModal #novios_results')[0].scrollIntoView();           
    }
})

// Refresh area to display the novios serach results form in billing section
wc.render.declareRefreshController({
    id: "FacturaFormModalAreaController",
    renderContext: wc.render.getContextById("FacturaFormModalAreaContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);
        
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;
        SinglePageCheckoutJS.loadCommunes('facturaForm','checkout_factura_city');
        unloadScrollBars();
        dojo.byId('ModalFactura').className = "Genericmodal";
        
        // Reset the properties
        renderContext.properties = {};
    }
})


// Refresh area to display the novios serach results form in shipping section
wc.render.declareRefreshController({
    id: "NoviosSearchFormController",
    renderContext: wc.render.getContextById("NoviosSearchFormContext"),
    url: "",
    formId: "",
    
    renderContextChangedHandler : function(message, widget) {
        var controller = this;        
        var renderContext = this.renderContext;              	
      	widget.refresh(renderContext.properties);       
    },

    postRefreshHandler: function(widget) {
        var controller = this;
        var renderContext = this.renderContext;   
        if(SinglePageCheckoutJS.selectedDeliveryOption != 'TabNovio'){
        	// display the novios search form
        	dojo.byId('select_novios_address').className = "show";
        	// hide the selected novios area
			dojo.byId('checkout_novios_address_detail').className = "hide";
        }        
    }
})
/** End: Ajax Refresh controller Declaration **/

/** Begin: Ajax Services Declaration **/

/** Start: Added for ClientLoginbyCSR Ajax CMD - on 26 April 2017 **/
wc.service.declare({
		id: "AjaxCallCenterLogin",
		actionId: "AjaxCallCenterLogin",
		url: getAbsoluteURL() + "CENCallCenterClientLoginCmd",
		formId: "",

		successHandler: function(serviceResponse) {
			window.location = getAbsoluteURL()+serviceResponse.redirecturl;
			
		},

		failureHandler: function(serviceResponse) {
			// reset the flag
			requestSubmitted=false;
			if(serviceResponse.exceptionData.errorReason) {
				MessageHelper.formErrorHandleClient(document.getElementById('clientLogonId').id, MessageHelper.messages[serviceResponse.exceptionData.errorReason]);
			}
			else if (serviceResponse.errorMessage) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
			} 
			else {
				 if (serviceResponse.errorMessageKey) {
					MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
				 }
			}
			
		}
	})
/**End: ClientLoginbyCSR Ajax CMD ***/

/**
 * This service adds a billing address to the order(s).
**/
wc.service.declare({
	id: "AddBillingAddress",
	actionId: "AddBillingAddress",
	url: getAbsoluteURL() + "AjaxPersonChangeServiceAddressAdd",
	formId: ""

/**
 * hides all the messages and the progress bar
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
 */
	,successHandler: function(serviceResponse) {
		//MessageHelper.hideAndClearMessage();
		//Reset the flag
		requestSubmitted = false;
		
		var addressId = serviceResponse.addressId;
		var form = document.forms[this.formId];
		
		if(undefined == form.addressId || null == form.addressId){
			var input = document.createElement("input");				
			input.setAttribute("type", "hidden");
			input.setAttribute("name", "addressId");
			input.setAttribute("id", "checkout_billing_addressId");
			input.setAttribute("value", addressId);
			var addrElement = dojo.byId('checkout_billing_addressfield1');
			addrElement.parentNode.appendChild(input);
		}		 
		// Refresh Step2: Enable the shipping options to the user
		// This will be called only for the guest user.
		wc.render.updateContext("shippingDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId,"userEmail":form.email1.value,"guestRUT":form.zipCode.value,"regUserRUT":"","bill_to_address_id":addressId,
								"userFirstName":form.firstName.value,"userLastName":form.lastName.value});
	}

/**
 * display an error message
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
*/
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		// Hide the progressbar
        removeProgressBar();
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
	}

})

/**
 * This service adds a billing address to the order(s).
**/
wc.service.declare({
	id: "AddEditShipAddress",
	actionId: "AddEditShipAddress",
	url: getAbsoluteURL() + "AjaxPersonChangeServiceAddressAdd",
	formId: ""

/**
 * hides all the messages and the progress bar
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
 */
	,successHandler: function(serviceResponse) {
		//MessageHelper.hideAndClearMessage();
		//Reset the flag
		requestSubmitted = false;
		
		var addressId = serviceResponse.addressId;
		var form = document.forms[this.formId];
		
		if(undefined == form.addressId || null == form.addressId){
			var input = document.createElement("input");				
			input.setAttribute("type", "hidden");
			input.setAttribute("name", "addressId");
			input.setAttribute("id", "checkout_shipping_addressId");
			input.setAttribute("value", addressId);
			var addrElement = dojo.byId('checkout_shipping_storeId');
			addrElement.parentNode.appendChild(input);
		}				 		
		// set the source of delivery option - will be used in orderitemdetails refresh area.
		SinglePageCheckoutJS.selectedDeliveryOption = "TabDespacho";
		
		// If existing address is being edited just update the address information from the form and pass the new address Id to updateaddressId method.
		if(undefined != form.formAction && null != form.formAction && form.formAction.value != "" 
			&& form.formAction.value == 'Edit'){
			
			// Disable the Add/Edit address area in order to show the list of address
	        if(dojo.byId('add_edit_address')){
	        	dojo.byId('add_edit_address').className = "hide";
	        }
	        var oldAddressId = form.addressId.value;
			var editedAddressInput = dojo.byId('select_ship_address_' + oldAddressId);
			editedAddressInput.value = addressId;
			editedAddressInput.checked = true;
			editedAddressInput.onclick = function() {SinglePageCheckoutJS.selectedDeliveryOption='TabDespacho';SinglePageCheckoutJS.updateAddressIdForAllItems(addressId)};
			editedAddressInput.id = 'select_ship_address_'+addressId;
			dojo.byId('address_content_' + oldAddressId).innerHTML = form.firstName.value + ", " + form.lastName.value + ", " + form.address1.value + ", " + form.address2.value + ", " + form.city.value + ", " + form.state.value;
			dojo.byId('address_content_' + oldAddressId).id = 'address_content_'+addressId;
			dojo.byId('address_link_' + oldAddressId).onclick = function() {SinglePageCheckoutJS.selectedDeliveryOption='TabDespacho';OpenModal('Edit',addressId)};
			dojo.byId('address_link_' + oldAddressId).id = 'address_link_' + addressId; 
			
			// Recalculate the order with selected address id and display the order item details	        
	        SinglePageCheckoutJS.updateAddressIdForAllItems(addressId);
	        	        	        
		}else {
			// Refresh Step2: Enable the selected address and enable the order item details
			wc.render.updateContext("shippingAddressListContext",{"orderId":SinglePageCheckoutJS.orderId,"addressId":serviceResponse.addressId,"updateOrderItem":true});
		}								
	}

	/**
	 * display an error message
	 * @param (object) serviceResponse The service response object, which is the
	 * JSON object returned by the service invocation
	*/
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		// To Hide the progress Bar
		removeProgressBar();
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
	}

})

/**
 * Declares an AJAX service that updates the shipping address for the gift items in single shipment scenario.
 * @constructor 
 */
wc.service.declare({
	id: "AjaxOrderChangeServiceGiftInfoUpdate",
	actionId: "AjaxOrderChangeServiceGiftInfoUpdate",
	url: getAbsoluteURL() + "AjaxOrderChangeServiceGiftInfoUpdate",
	formId: ""
	
	/**
	 * hides all the messages and the progress bar
	 * @param (object) serviceResponse The service response object, which is the
	 * JSON object returned by the service invocation
	 */
	,successHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		//MessageHelper.hideAndClearMessage();
		//cursor_clear();
	}
	
	/**
	 * Displays the error message returned with the service response and hides the progress bar.
	 *
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			//If Gift Registry wants to override this errorMessage with it's own..
			if(MessageHelper.messages[serviceResponse.errorMessageKey] != null && MessageHelper.messages[serviceResponse.errorMessageKey] != undefined){
				MessageHelper.displayErrorMessage(MessageHelper.messages[serviceResponse.errorMessageKey]);
			}
			else {
				//Display default error message..
				MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
			}
		} else if (serviceResponse.errorMessageKey) {
			//No message set..Display message key..
			MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
		}
		//cursor_clear();
	}

})

/**
 * Declares an AJAX service that updates the shipping address and shipping method for items in the order.
 * @constructor 
 */
wc.service.declare({
	id: "OrderItemAddressShipMethodUpdate",
	actionId: "OrderItemAddressShipMethodUpdate",
	url: getAbsoluteURL() + "AjaxOrderChangeServiceShipInfoUpdate", 
	formId: ""
	
	/**
	 * hides all the messages and the progress bar
	 * @param (object) serviceResponse The service response object, which is the
	 * JSON object returned by the service invocation
	 */
	,successHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		var params = [];
		params.storeId		= this.storeId;
		params.catalogId	= this.catalogId;
		params.langId		= this.langId;
		params.orderId 		= serviceResponse.orderId;
		
		//MTHN: Display Model If any allocation failed items from response
		if(serviceResponse.failedAllocation){
			CheckoutModalJS.showModal(serviceResponse);
		}else{
			wc.service.invoke("AjaxPrepareOrderService", params);
		}				
	}
	
	/**
	 * Displays the error message returned with the service response and hides the progress bar.
	 *
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		MessageHelper.timoutDelay = 15000;
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();		
		var elem = document.getElementById("ShoppingCartURL");
		if(elem != undefined && elem != null){
			setTimeout(function(){
				location.href = elem.value;
				}, 2000);
			
		}
		MessageHelper.timoutDelay = 10000;
		//cursor_clear();
	}

})

wc.service.declare({
	id: "AjaxPrepareOrderService",
	actionId: "AjaxPrepareOrderService",
	url: getAbsoluteURL() + "AjaxOrderProcessServiceOrderPrepare",
	formId: ""
    /** 
   * hides all the messages and the progress bar
   * @param (object) serviceResponse The service response object, which is the
   * JSON object returned by the service invocation
   */
	,successHandler: function(serviceResponse) {
		
		//Reset the flag
		requestSubmitted = false;
		
		var params = [];
		params.storeId		= this.storeId;
		params.catalogId	= this.catalogId;
		params.langId		= this.langId;
		params.URL="";
		params.orderId = serviceResponse.orderId;
		params.calculationUsageId = ["-1","-2","-3","-4","-5","-6","-7"];
		
		wc.service.invoke("AjaxOrderCalculate", params);
	}

    /**
   * hides all the messages and the progress bar
   * @param (object) serviceResponse The service response object, which is the
   * JSON object returned by the service invocation
   */
	,failureHandler: function(serviceResponse) {
		
		//Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
	}

})

/**
 * Perform the order calculation operations to compute the contract prices for the order items in an order.
 * Perform the service or command call.
 * On success of order calculate refresh the orderItemDetails section
 */
wc.service.declare({
	id: "AjaxOrderCalculate",
	actionId: "AjaxOrderCalculate",
	url: getAbsoluteURL() + "AjaxOrderCalculate",
	formId: ""

     /**
     * display a success message
     * @param (object) serviceResponse The service response object, which is the
     * JSON object returned by the service invocation
     */

	,successHandler: function(serviceResponse) {
				
		//Reset the flag
		requestSubmitted = false;
		
		if(typeof serviceResponse.URL != 'undefined') {
			var returnUrl = (serviceResponse.URL).toString();
			if(dojo.trim(returnUrl) != ""){
				document.location.href = returnUrl.replace(/&amp;/g, '&');
			}
		}
					
		if(typeof (CheckoutModalJS) != 'undefined' && CheckoutModalJS != null &&
				serviceResponse.orderHasValidItems != null && serviceResponse.orderHasValidItems){
			CheckoutModalJS.orderHasValidItems = true;
		}
		//This is defined in singlepagecheckoutmodal.js
		dojo.publish("ajaxOrderCalculateComplete");
		
		// Refresh Step2: Enable/Refresh the order item details section				
		if(null == serviceResponse.orderHasValidItems || serviceResponse.orderHasValidItems == true){
			wc.render.updateContext("orderItemDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId});
		}		
	}
	
    /**
     * display an error message
     * @param (object) serviceResponse The service response object, which is the
     * JSON object returned by the service invocation
     */
	,failureHandler: function(serviceResponse) {
		
		//Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			if (serviceResponse.errorCode == "CMN0409E")
			 {
				 MessageHelper.displayErrorMessage(MessageHelper.messages["ORDER_NOT_COPIED"]);
			 }
			 else
			 {
				 MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
			 }
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
		
		//This is defined in singlepagecheckoutmodal.js			
		dojo.publish("ajaxOrderCalculateComplete");
				
	}

})

/**
 * Remove an item from shopping cart. A message is displayed after the service
 * call.
 * @constructor
 */
wc.service.declare({
	id: "AjaxDeleteOrderItem",
	actionId: "AjaxDeleteOrderItem",
	url: getAbsoluteURL() + "AjaxOrderChangeServiceItemDelete",
	formId: ""
    /**
     * display a success message
     * @param (object) serviceResponse The service response object, which is the
     * JSON object returned by the service invocation
     */
	,successHandler: function(serviceResponse, ioArgs) {
		//MessageHelper.hideAndClearMessage();
		//Reset the flag
		requestSubmitted = false;
		
		// To close the warranty modal
		closeWarrantyModal();
				
		MessageHelper.displayStatusMessage(MessageHelper.messages["SHOPCART_REMOVEITEM"]);
		
		if(SinglePageCheckoutJS.redirectToShopcart){
			document.location.href = document.getElementById("ShoppingCartURL").value;
		} else {
			// Refresh Step2: Enable/Refresh the order item details section
			wc.render.updateContext("orderItemDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId});
			
			// Update the C&C order items.
			// SinglePageCheckoutJS.updateValidCCOrderItems(ioArgs);
		}						
		
		//cursor_clear();
	}
     /**
     * display an error message
     * @param (object) serviceResponse The service response object, which is the
     * JSON object returned by the service invocation
     */
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		// To close the warranty modal
		closeWarrantyModal();
		
		// To Hide the progress Bar
		removeProgressBar();
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
	}

})
/**
 * This service first will delete the warranty orderitem and then 
 * add the new warranty item from the saved values,
 */
wc.service.declare({
	id: "AjaxChangeWarrantyItemInCart",
	actionId: "AjaxChangeWarrantyItemInCart",
	url: getAbsoluteURL() + "AjaxOrderChangeServiceItemDelete",
	formId: ""
	
	/**
	 * display a success message
	 * @param (object) serviceResponse The service response object, which is the
	 * JSON object returned by the service invocation
	 */
	,successHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		var orderItemIdFrom = document.getElementById("warrantyItemOrderItemIDFrom").value;
		
		var catEntryIdTo = SinglePageCheckoutJS.catEntryIdTo;
		var qty = document.getElementById('qty_for_orderItem_' + orderItemIdFrom).value;
		
		var params = [];
		params.isWarrantyItem = true;
		params.orderItemIdFrom = orderItemIdFrom;
		params.warrantyYears = SinglePageCheckoutJS.warrantyYears;
		params.guaranteeType = SinglePageCheckoutJS.warrantyType;		
		SinglePageCheckoutJS.AddItem2ShopCartAjax(catEntryIdTo, qty, params);
	}
	
	/**
	 * display an error message
	 * @param (object) serviceResponse The service response object, which is the
	 * JSON object returned by the service invocation
	 */
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		// To close the warranty modal
		closeWarrantyModal();
		
		// To Hide the progress Bar
		removeProgressBar();
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
	}
})

/**
 * Adds a warranty item to cart.
 */
wc.service.declare({
	id: "AjaxWarrantyItemAddService",
	actionId: "AjaxWarrantyItemAddService",
	url: getAbsoluteURL() + "AjaxOrderChangeServiceItemAdd",
	formId: ""

	/**
	* display a success message
	* @param (object) serviceResponse The service response object, which is the
	* JSON object returned by the service invocation
	*/
	,successHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
	
		// To close the warranty modal
		closeWarrantyModal();
		
		var params = [];
		params.storeId		= this.storeId;
		params.catalogId	= this.catalogId;
		params.langId		= this.langId;
		params.URL="";
		params.orderId = serviceResponse.orderId;
		params.calculationUsageId = ["-1","-2","-3","-4","-5","-6","-7"];
		
		wc.service.invoke("AjaxOrderCalculate", params);
		
		//MessageHelper.hideAndClearMessage();
		//cursor_clear();
	}

	/**
	* display an error message
	* @param (object) serviceResponse The service response object, which is the
	* JSON object returned by the service invocation
	*/
	,failureHandler: function(serviceResponse) {
		//Reset the flag
		requestSubmitted = false;
		
		// To close the warranty modal
		closeWarrantyModal();
		
		// To Hide the progress Bar
		removeProgressBar();
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();
	}

})

/**
 * Declares an AJAX service that prepares order information before submitting the order.
 * On success of this service call hide step 2 (Shipping Information) and enable Step 3( Payment Details)
 * @constructor
 */
wc.service.declare({
	id: "AjaxPrepareOrderBeforePaymentCapture",
	actionId: "AjaxPrepareOrderBeforePaymentCapture",
	url: getAbsoluteURL() + "AjaxOrderProcessServiceOrderPrepare",
	formId: ""
	
	/**
	 * Submits the order with the name of the payment form.
	 *
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		// If EOM failed to allocate item, display that information in popup		
		if(serviceResponse.failedAllocation){
			CheckoutModalJS.showModal(serviceResponse);			
			return;
		}else{				        
	        // Refresh Step3: Enable the payment options to the user
			wc.render.updateContext("paymentDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId});
		}		
		
	}

	
	/**
	 * Displays the error message returned with the service response and hides the progress bar.
	 *
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		MessageHelper.timoutDelay = 15000;
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}		
		// cursor_clear();
		// Added a script to hold the error message for 15 seconds.
		// And redirect to shop cart page.
		var elem = document.getElementById("ShoppingCartURL");
		if(elem != undefined && elem != null){
			setTimeout(function(){
				location.href = elem.value;
				}, 2000);
			
		}
		MessageHelper.timoutDelay = 10000;		
	}

})

// Proxy pickup  service declaration
wc.service.declare({
	id: "AjaxCENUpdatePickUpProxyDetails",
	actionId: "AjaxCENUpdatePickUpProxyDetails",
	url: getAbsoluteURL() + "AjaxCENUpdatePickUpProxyDetails",
	formId: ""

	/**
     *  @param (object) serviceResponse The service response object, which is the
     *  JSON object returned by the service invocation. 
     */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		// requestSubmitted = false;
		SinglePageCheckoutJS.processCheckoutShippingDetails();
	}
	
    /**
    * display an error message.
    * @param (object) serviceResponse The service response object, which is the
    * JSON object returned by the service invocation.
    */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		// cursor_clear();
	}
})

/**
 * Service call to update novios code to order
 * On success, refresh the selected novios address and order item details section of step 2
 */
wc.service.declare({
	id: "AjaxNoviosSection",
	actionId: "AjaxNoviosSection",
	url: getAbsoluteURL() + "CENNoviosCodeUpdateCmd",
	formId: ""

	/**
	 * Clear messages on the page.
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation
	 */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		// Step 2 - Novios
		if(true != serviceResponse.billingPage){
			
			var codigoNovios = serviceResponse.codigo[0];
			if((codigoNovios!="") && (codigoNovios != undefined)){
				if((codigoNovios).length<8){
					for(var i=(codigoNovios).length;i<8;i++){
						codigoNovios='0'+codigoNovios;
					}
				}
			}
			// Refresh the selected novios address area and parallal to that update the order items area
			
			// Update the name and code to selected novios div
			dojo.query('#novios_address_name p')[0].innerHTML = dojo.trim(SinglePageCheckoutJS.noviosNames).replace('/', 'y');
			dojo.query('#novios_address_code p')[0].innerHTML = SinglePageCheckoutJS.noviosCode;			
			// Hide the novios search results area
			dojo.byId('select_novios_address').className = "hide";
			// show the selected novios area
			dojo.byId('checkout_novios_address_detail').className = "show";
			
			//wc.render.updateContext("selectedNoviosAddressAreaContext",{"orderId":SinglePageCheckoutJS.orderId,"noviosCode":SinglePageCheckoutJS.codigoNovios});
			// Set default addressId For Novios flow to -3
			SinglePageCheckoutJS.updateAddressIdForAllItems("-3",codigoNovios);
			//cursor_clear();
		}else if(serviceResponse.billingPage){
			// Refresh Step3: Enable the payment options to the user
			wc.render.updateContext("paymentDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId});
		}
	}
	
	/**
	 * Displays an error message on the page if the request failed.
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		// To Hide the progress Bar
		removeProgressBar();

		// If modal is opened close the modal
		if(dojo.byId("NoviosSearchFormModal")){
			SinglePageCheckoutJS.closeNoviosModal();
		}
		
		if(serviceResponse.errorMessageKey == '_ERR_CMD_INVALID_PARAM'){
			MessageHelper.displayErrorMessage(MessageHelper.messages["ERROR_INVALID_NOVIOS_CODE"]);			
		}
		else if(serviceResponse.errorMessageKey == '_ERR_CAT_NOT_EXISTING'){
			MessageHelper.displayErrorMessage(MessageHelper.messages["ERROR_EXPIRED_NOVIOS_CODE"]);
			
		}else{
			MessageHelper.displayErrorMessage(MessageHelper.messages["ERROR_codigoModelEmpty"]);			
		}
		//cursor_clear();
	}
		
})


/**
* Declares an AJAX service that adds a payment instruction to the current order.
* @constructor
*/
wc.service.declare({
	id: "AjaxAddPaymentInstructionToThisOrder",
	actionId: "AjaxAddPaymentInstructionToThisOrder",
	url: getAbsoluteURL() + "AjaxOrderChangeServicePIAdd",
	formId: ""
	
	/**
	 * Resets the array object that contains payment objects to add. Verifies if there is any payment instruction that needs to be updated.
	 * If there is no payment instruction that needs to be updated, direct the browser to the order summary page.
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		dojo.byId('piId').value = serviceResponse.piId;
		dojo.byId('existingPids').value = serviceResponse.piId; 
		
		console.debug("pid>>>"+serviceResponse.piId)
		var cbsPayment=true;
//		if(cbsPayment){
//		  SinglePageCheckoutJS.processCBSCheckout(serviceResponse.piId)
//		}else{
		// This method will redirect the user to payment hub page.
		//SinglePageCheckoutJS.processCheckoutCustom();
		dojo.publish("CustomProcessCheckout");
//		}
	}
	
	/**
	 * Resets the array object that contains existing payment objects to add.
	 * Displays the error message returned with the service response and hides the progress bar.
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
				
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();
		
	}

})

/**
* Declares an AJAX service that deletes payment instructions from the current order.
* @constructor
*/
wc.service.declare({
	id: "AjaxDeletePaymentInstructionFromThisOrder",
	actionId: "AjaxDeletePaymentInstructionFromThisOrder",
	url: getAbsoluteURL() + "AjaxOrderChangeServicePIDelete",
	formId: ""
	
	/**
	 * Removes piId from payment objects and payment forms on the page, clears the progress bar.
	 * Invokes the AjaxPrepareOrderBeforeProceedingToSummary service to prepare order information.
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,successHandler: function(serviceResponse) {		
		// Reset the flag
		requestSubmitted = false;
		// Add a new payment instruction
		//SinglePageCheckoutJS.addPaymentInstructions();
		dojo.publish("CustomAddPaymentInstruction");
				
	}
	
	/**
	 * Resets the array object that contains existing payment objects to delete.
	 * Displays the error message returned with the service response and hides the progress bar.
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();
	}

})

wc.service.declare({
	id: "MhtnOrderItemUpdate",
	actionId: "MhtnOrderItemUpdate",
	url:  getAbsoluteURL() + "AjaxOrderItemUpdate",
	formId: ""

	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		var params = {};
		params.storeId		= SinglePageCheckoutJS.storeId;
		params.catalogId	= SinglePageCheckoutJS.catalogId;
		params.langId		= SinglePageCheckoutJS.langId;
		params.orderId 		= serviceResponse.orderId;
								
		params.URL="";
		params.calculationUsageId = ["-1","-2","-3","-4","-5","-6","-7"];
		wc.service.invoke("AjaxOrderCalculate", params);
				
	}
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();
	}
})

wc.service.declare({
	id: "MhtnOrderItemUpdateCC",
	actionId: "MhtnOrderItemUpdateCC",
	url: getAbsoluteURL() + "AjaxOrderItemUpdate",
	formId: ""

	,successHandler: function(serviceResponse) {	
		// Reset the flag
		requestSubmitted = false;
		if(SinglePageCheckoutJS.deleteAllItems){
			// Order doesn't have order items so redirect to Home Page
			window.location.href = "/";
		}else {
			// Reset the flag
			requestSubmitted = false;
			// Close the modal
			SinglePageCheckoutJS.closePickupModal();
			// This will pass selected physical store addressId to updateorderitem command.
			dojo.publish('CustomSelectPhyscialStore');
		}
	}
	,failureHandler: function(serviceResponse) {
		window.location.href = "/";
	}
})

/**
 * Declares an AJAX service that updates the requested ship date
 * @constructor 
 */
wc.service.declare({
	id: "OrderItemRequestShipDateUpdate",
	actionId: "OrderItemAddressShipMethodUpdate",
	url: getAbsoluteURL() + "AjaxOrderItemUpdate",
	formId: ""
	
	/**
	 * hides all the messages and the progress bar
	 * @param (object) serviceResponse The service response object, which is the
	 * JSON object returned by the service invocation
	 */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		//MTHN: Start Req# INT1875 : Create Update order OEM
		try{
			// If the the date modal opened by EOM exceptipon - date not available 
			if(CheckoutModalJS && CheckoutModalJS.isOpen){
				CheckoutModalJS.updateDates();
			}
		}catch(e){
			
		}
	
		var params = [];
		params["storeId"] = this.storeId;
		params["catalogId"] = this.catalogId;
		params["langId"] = this.langId;
		params.orderId = ".";
		params.calculationUsageId = ["-1","-2","-3","-4","-5","-6","-7"];
		params.allocate="***";
		params.backorder="***";
		params.remerge="***";
		params.check="*n";

		params.requestedShipDate_1="dummy";
		params.mhtnOrderItemId = serviceResponse.orderItemId;
		params.mhtnSecondDateTagValue = serviceResponse.mhtnSecondDateTagValue;
		params["mhtnOrderJornada"] = serviceResponse.mhtnOrderJornada;

		params.URL="";
		wc.service.invoke("AjaxOrderCalculate", params);

		//MessageHelper.hideAndClearMessage();		
	}
	
	/**
	 * Displays the error message returned with the service response and hides the progress bar.
	 *
	 * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
	 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();
	}

})

/**
 * This service applies the promotion code to the order(s).
 */
wc.service.declare({
	id: "AjaxPromotionCodeManage",
	actionId: "AjaxPromotionCodeManage",
	url: getAbsoluteURL() + "AjaxPromotionCodeManage",
	formId: ""

/**
 * hides all the messages and the progress bar
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
 */
	,successHandler: function(serviceResponse) {
		//MessageHelper.hideAndClearMessage();

		// Reset the flag
		requestSubmitted = false;
		
		var params = [];
		
		params.storeId		= SinglePageCheckoutJS.storeId;
		params.catalogId	= SinglePageCheckoutJS.catalogId;
		params.langId		= SinglePageCheckoutJS.langId;
		
		params.orderId = ".";
		params.calculationUsage = "-1,-2,-3,-4,-5,-6,-7";
		
		wc.service.invoke("AjaxUpdateOrderItem",params);
		
	}

 /**
 * display an error message
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
 */
	,failureHandler: function(serviceResponse) {

		// Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {		 			
			dojo.byId('error_msg_promo').innerHTML = serviceResponse.errorMessage;
			dojo.byId('error_msg_promo').style.display = 'block';		
			if(serviceResponse.errorCode == '-1900'){
				var promoErrMsg=MessageHelper.messages["PROMO_LIMIT_EXCEEDED_1900"];
				dojo.byId('error_msg_promo').innerHTML = promoErrMsg;
				dojo.byId('error_msg_promo').style.display = 'block';
			}			
		} 
		else {
			 if (serviceResponse.errorMessageKey) {		
				 dojo.byId('error_msg_promo').innerHTML = serviceResponse.errorMessageKey;
				 dojo.byId('error_msg_promo').style.display = 'block';
			 }
		}
		//cursor_clear();
	}

})
	
/**
 * This service updates an order item in the shopping cart.
 * A message is displayed after the service call.
 * @constructor
 */
wc.service.declare({
	id: "AjaxUpdateOrderItem",
	actionId: "AjaxUpdateOrderItem",
	url: getAbsoluteURL() + "AjaxOrderChangeServiceItemUpdate",
	formId: ""

/**
 * hides all the messages and the progress bar
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
 */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		// Refresh step 3: payment section 
		wc.render.updateContext("paymentDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId});
		
		//MessageHelper.hideAndClearMessage();
		//cursor_clear();
	}

/**
 * display an error message
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation
 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		if (serviceResponse.errorMessage) {
			if (serviceResponse.errorMessageKey == "_ERR_RETRIEVE_PRICE") {
				MessageHelper.displayErrorMessage(MessageHelper.messages["ERROR_RETRIEVE_PRICE_QTY_UPDATE"]);
			}
			else{
				MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
			}
		} 
		else {
			 if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			 }
		}
		//cursor_clear();
	}

})

/**
 * This service invokes ApplyGiftCard command.
 */

wc.service.declare({
	id: "AjaxGiftCardSection",
    actionId: "AjaxGiftCardSection",
    url: getAbsoluteURL() + "ApplyGiftCardCmd",
    formId: ""

    /**
      * Clear messages on the page.
      * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation
    */
    ,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
				
		var params = [];
		params['orderId'] = serviceResponse.orderId;
		params['giftCardNumber'] = serviceResponse.giftCardNumber;
		params['giftCardPassword'] = serviceResponse.password;
		params['applicableBalance'] = serviceResponse.applicableBalance;
		params['piAmount'] = serviceResponse.piAmount;
		params['giftCardPaymentAmount'] = serviceResponse.piAmount;
		//renderContext.properties['isFacturaSelected'] = document.getElementById('isFacturaSelected').value;
		params['TRUT'] = serviceResponse.TRUT;	
		params['remainingAmount'] = serviceResponse.orderTotal - serviceResponse.piAmount;
		params['wasGiftCardUsed'] = true;
		
		// Refresh the Step 3: payment details section
		wc.render.updateContext("paymentDetailsAreaContext",params);
		
	}
      
    /**
     * Displays an error message on the page if the request failed.
     * @param (object) serviceResponse The service response object, which is the JSON object returned by the service invocation.
    */
    ,failureHandler: function(serviceResponse) {
    	// Reset the flag
  		requestSubmitted = false;
    	if(serviceResponse){
    		if(serviceResponse.exceptionData){
    			MessageHelper.displayErrorMessage(MessageHelper.messages[serviceResponse.exceptionData.errorReason]);
    		}else{
	    		if (serviceResponse.errorMessage) {
	    			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
	    		}else {
	    			if (serviceResponse.errorMessageKey) {
	    				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
	    			}
	    		}
    		}
    	}
    	//cursor_clear();
    	
    	// Hide the progressbar
        removeProgressBar();
      }
})


wc.service.declare({
	id: "AjaxFacturaAdd",
	actionId: "AjaxFacturaAdd",
	url: getAbsoluteURL() + "AjaxPersonChangeServiceAddressAdd",
	formId: ""

 /**
  *  @param (object) serviceResponse The service response object, which is the
  *  JSON object returned by the service invocation. 
  */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
	 	
		SinglePageCheckoutJS.updateFactura(serviceResponse.addressId, true);
	}
	
/**
 * display an error message.
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation.
 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
  		requestSubmitted = false;
  		
  		// Remove the progress Bar
  		removeProgressBar()
		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
	}
}),

wc.service.declare({
	id: "AjaxCENOrderUpdateService",
	actionId: "AjaxCENOrderUpdateService",
	url: getAbsoluteURL() + "CENOrderUpdateCmd",
	formId: ""

 /**
  *  @param (object) serviceResponse The service response object, which is the
  *  JSON object returned by the service invocation. 
  */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		// Refresh Step3: Refresh the payment section after the successful of factura form add.
		wc.render.updateContext("paymentDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId});
		
	}
	
/**
 * display an error message.
 * @param (object) serviceResponse The service response object, which is the
 * JSON object returned by the service invocation.
 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
  		requestSubmitted = false;
  		
  		// Remove the progress Bar
  		removeProgressBar()
  		
		if (serviceResponse.errorMessage) {
			MessageHelper.displayErrorMessage(serviceResponse.errorMessage);
		} else {
			if (serviceResponse.errorMessageKey) {
				MessageHelper.displayErrorMessage(serviceResponse.errorMessageKey);
			}
		}
		//cursor_clear();
	}
})

/**
 * Service call for MapCity
 */
wc.service.declare({
	id: "AjaxCENCallRESTFulService",
	actionId: "AjaxCENCallRESTFulService",
	url: getAbsoluteURL() + "AjaxCENCallRESTFulService",
	formId: ""

	/**
	 *  @param (object) serviceResponse The service response object, which is the
	 *  JSON object returned by the service invocation. 
	 */
	,successHandler: function(serviceResponse) {
		// Reset the flag
		requestSubmitted = false;
		
		//cursor_clear();
		console.debug(serviceResponse);
		if(serviceResponse && serviceResponse.successHandler && (typeof serviceResponse.withError === 'undefined')){
			eval(serviceResponse.successHandler)(serviceResponse);
		}else if(serviceResponse && serviceResponse.failureHandler && !(typeof serviceResponse.withError === 'undefined')){
			eval(serviceResponse.failureHandler)(serviceResponse);
		}else{
			// Finally save the address
			dojo.publish('CustomSaveAddressHandler');
		}
	}
	
	/**
	 * display an error message.
 	 * @param (object) serviceResponse The service response object, which is the
 	 * JSON object returned by the service invocation.
 	 */
	,failureHandler: function(serviceResponse) {
		// Reset the flag
  		requestSubmitted = false;
  		
		// cursor_clear();
		if(serviceResponse && serviceResponse.failureHandler){
			eval(serviceResponse.failureHandler)(serviceResponse);
		}else{			
			// Finally save the address
			dojo.publish('CustomSaveAddressHandler');
		}
	}
})

/** End: Ajax Services Declaration **/

/** Begin: Common funtions used in different methods **/

// Format the user's RUT
function formatRut(rut){
	return (rut.replace(/[.-]/g, "")).toUpperCase();
}

// Validate the user's RUT 
function validateRut(logonid){
	
	logonid = logonid.replace(/[.-]/g, "");
	
	var bufferZeros = 9-(logonid.length);
	if((logonid.length)<6){
		
		return false;
	}
	var count = 0;
	for(var i = 0; i < logonid.length; i++){		
		if(logonid.charAt(i)=='0'){
			count++;
		}		
	}	
	if(count == logonid.length){
		return false;
	}	
	if((logonid.length)<9){
		for(i=0; bufferZeros > i; i++){
			logonid = '0'.concat(logonid);
		}
	}
	// RUT format XXXXXXXX-Y 
	var regexRut =  /^(\d{2})(\.?)(\d{3})(\.?)(\d{3})(\-?)[\dKk]$/;
	if (!regexRut.test(logonid)) {
		return false;
	}	
			
	var RUT_CHECK_DIGIT = '32765432';	
	var rutSum = 0;
	var restDigit = 0;
	var digitVerifier = '0';
	
	logonid = logonid.toUpperCase();	
	rut = logonid.substring(0,8);
	rutCheck = logonid.charAt(logonid.length-1);
	
	// Step 1 = multiply each digit of rut with each digit of rutCheckDigit
	for(i=0;i<rut.length;i++)
	{
		rutSum = rutSum + (rut.charAt(i) * RUT_CHECK_DIGIT.charAt(i));
	}
	
	//Step 2: Take mod 11 of rutSum and get the remainder
	restDigit = (rutSum % 11);
	
	//Step 3: calculate the check digit
	if((11 - restDigit) == 11)
		digitVerifier = '0';
	else
	{
		if((11 - restDigit) == 10)
			digitVerifier = 'K';
		else
			digitVerifier = 11 - restDigit;
	}
	
	//Step 4: evaluate if digitVerifier is the same as rutCheck digit that the user has entered		
	if(!(rutCheck == digitVerifier))
	{
		return false;
	}
	return true;
}


//Validate the field value against accepted characters
function validateAccentedCharacters (name,regExpr){
	splitName = name;
	i=0;
	isValid = true;
	while (i < splitName.length){
		if(splitName[i]=='=' || splitName[i]==';'){
			return false;
		}
	if(!regExpr.test(splitName[i])){
		temp = splitName[i];
		if(!(temp.charCodeAt(0)==209 ||temp.charCodeAt(0)==241 || temp.charCodeAt(0)==193 ||temp.charCodeAt(0)==201 || temp.charCodeAt(0)==205 || temp.charCodeAt(0)==211 || temp.charCodeAt(0)==218 ||temp.charCodeAt(0)==225 || temp.charCodeAt(0)==233 || temp.charCodeAt(0)==237 || temp.charCodeAt(0)==243 || temp.charCodeAt(0)==250)){
		 isValid = false;
		 return isValid;
		}
	}
	i++;
	}
	return isValid;
}
//Format RUT
function formatoRut(RutOj)
{
    var texto    = RutOj.value;
    var valortem = "";  
    if (!(texto))
        {
            return true;
        }   

    for ( i=0; i < texto.length ; i++ )
        {
            if ( texto.charAt(i) != ' ' && texto.charAt(i) != '.' && texto.charAt(i) != '-' )
                {
                    valortem = valortem + texto.charAt(i);
                }
        }
        
    texto = valortem;
    largo = texto.length;

    if ( largo < 2 )
        {
            return false;
        }
    for (i=0; i < largo ; i++ )
        { 
            if ( texto.charAt(i) !="0" && texto.charAt(i) != "1" && texto.charAt(i) !="2" && texto.charAt(i) != "3" && texto.charAt(i) != "4" && texto.charAt(i) !="5" && texto.charAt(i) != "6" && texto.charAt(i) != "7" && texto.charAt(i) !="8" && texto.charAt(i) != "9" && texto.charAt(i) !="k" && texto.charAt(i) != "K" ) 
                {
                    return false;
                }
        }
    var ValorInvertido = "";
    for ( i=(largo-1),j=0; i>=0; i--,j++ )
    {
        ValorInvertido = ValorInvertido + texto.charAt(i);
    }
  
    var CharText = "";
    CharText = CharText + ValorInvertido.charAt(0);
    CharText = CharText + '-';
    counter = 0;

    for ( i=1,j=2; i<largo; i++,j++ )
    {
        if ( counter == 3 )
        {
            CharText = CharText + '.';
            j++;
            CharText = CharText + ValorInvertido.charAt(i);
            counter = 1;
        }
        else
        { 
            CharText = CharText + ValorInvertido.charAt(i);
            counter++;
        }
    }

    ValorInvertido = "";
    for ( i=(CharText.length-1),j=0; i>=0; i--,j++ )
    {
        ValorInvertido = ValorInvertido + CharText.charAt(i);
    }

    RutOj.value = ValorInvertido;
    return false;
}
function soloRut(e){
       key = e.keyCode || e.which;
       tecla = String.fromCharCode(key).toLowerCase();
       letras = " 1234567890-k.";
       especiales = "8-37-39-46";

       tecla_especial = false
       for(var i in especiales){
            if(key == especiales[i]){
                tecla_especial = true;
                break;
            }
        }

        if(letras.indexOf(tecla)==-1 && !tecla_especial){
            return false;
        }
}



// To select RUT/DNI for Guest user billing address form 
function selectGuestIdentity(identity){		
	var selectedIdentity = dojo.byId('checkout_billing_addressfield1').value;
	if(null != identity && undefined != identity && "" != identity){
		selectedIdentity = identity;
	}
	
	// Remove the identity when user switch the option
	if(identity){
		dojo.byId('checkout_billing_guestIdentity').value = "";
	}
	
	if(selectedIdentity == '' || selectedIdentity == 'RUT' ){
		dojo.byId('checkout_billing_option_rut').checked = 'true';
		dojo.byId('example_dni').style.display = "none";
		dojo.byId('example_rut').style.display = "block";
		dojo.byId('checkout_billing_addressfield1').value = "RUT";
	}else {
		dojo.byId('checkout_billing_option_dni').checked = 'true';
		dojo.byId('example_rut').style.display = "none";
		dojo.byId('example_dni').style.display = "block";
		dojo.byId('checkout_billing_addressfield1').value = "DNI";
	}			
}

// Validate Address fields for given form
function validateAddressForm(form){
	reWhiteSpace = new RegExp(/^\s+$/);
	specialCharactersRegex1 = new RegExp(/^[A-Za-z0-9_\s.,-\/]/);
	specialCharactersRegex2 = new RegExp(/^[A-Za-z0-9_!?,.()@$"#?\s&\/%-]/);	
	isValid = true;
	
	var fields = form["AddressForm_FieldsOrderByLocale"].value.split(",");	
	var userTypeCheckOut = form["userTypeCheckOut"].value;
	var lastName = "lastName";
	var firstName = "firstName";
	var middleName = "middleName";
	var address1 = "address1";
	var address2 = "address2";
	var address3 = "address3";
	var depto = "addressField2";
	var city = "city";
	var state = "state";
	var country = "country";
	var zipCode = "zipCode";
	var email1 = "email1";
	var phone1 = "phone1";
	var phone2 = "phone2";
	var rut = "billingCode";
	var comments = "address3";
	var guestIdentity = "guestIdentity";
	var addressField1 = "addressField1";
	var addressField3 = "addressField3";
	// MAPCITY fields
	var addressFlag = "addressFlag";
	var addressLatitude = "addressLat";
	var addressLongitude = "addressLon";
	// Error Message Field
	var errorMsgSuffix = "_errormsg"
	
	
	for(var i=0; i<fields.length; i++) {
		var field = fields[i];
		
		if(field == "firstName") {
			form[firstName].value = trim(form[firstName].value);
			if(form[firstName].value == "" || reWhiteSpace.test(form[firstName].value)){ 
				displayErrorMessage(form[firstName].id + errorMsgSuffix, MessageHelper.messages["ERROR_FirstNameEmpty"]);
				return false;
			}
			isValid = validateAccentedCharacters(form[firstName].value,specialCharactersRegex1);
		    if(form[firstName] != null && !isValid){ 
		    	displayErrorMessage(form[firstName].id + errorMsgSuffix, MessageHelper.messages["ERROR_INVALID_FIRST_NAME"]); 
				return false;
				}
			if(!MessageHelper.isValidUTF8length(form[firstName].value, 128)){ 
				displayErrorMessage(form[firstName].id  + errorMsgSuffix, MessageHelper.messages["ERROR_FirstNameTooLong"]);
				return false;
			}
		}	
		else if(field == "lastName") {
			form[lastName].value = trim(form[lastName].value);
			if(form[lastName].value == "" || reWhiteSpace.test(form[lastName].value)){ 
				displayErrorMessage(form[lastName].id + errorMsgSuffix, MessageHelper.messages["ERROR_LastNameEmpty"]);
				return false;
			}
			isValid = validateAccentedCharacters(form[lastName].value,specialCharactersRegex1);
		    if(form[lastName] != null && !isValid){ 
		    	displayErrorMessage(form[lastName].id + errorMsgSuffix, MessageHelper.messages["ERROR_INVALID_LAST_NAME"]); 
				return false;
				}
			if(!MessageHelper.isValidUTF8length(form[lastName].value, 128)){ 
				displayErrorMessage(form[lastName].id + errorMsgSuffix, MessageHelper.messages["ERROR_LastNameTooLong"]);
				return false;
			}
		}		
		else if(field == "email1") {
			form[email1].value = trim(form[email1].value);
			emailValidationRegEx = new RegExp(/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([A-Za-z]{2,6}(?:\.[A-Za-z]{2})?)$/);
			if(form[email1].value == "" || reWhiteSpace.test(form[email1].value)){
				displayErrorMessage(form[email1].id + errorMsgSuffix, MessageHelper.messages["ERROR_EmailEmpty"]);
				return false;
			}
			if(!MessageHelper.isValidUTF8length(form[email1].value, 256)){ 
				displayErrorMessage(form[email1].id + errorMsgSuffix, MessageHelper.messages["ERROR_EmailTooLong"]);
				return false;
			}
			if(!emailValidationRegEx.test(form[email1].value)){				
				displayErrorMessage(form[email1].id + errorMsgSuffix, MessageHelper.messages["ERROR_INVALIDEMAILFORMAT"]);
				return false;
			}
		}
		else if(field == "phone1"){
			form[phone1].value = trim(form[phone1].value);
			if(form[phone1].value == "" || reWhiteSpace.test(form[phone1].value)){
				displayErrorMessage(form[phone1].id + errorMsgSuffix, MessageHelper.messages["ERROR_PhonenumberEmpty"]);
				return false;
			}
			if(!MessageHelper.isValidUTF8length(form[phone1].value, 32)){ 
				displayErrorMessage(form[phone1].id + errorMsgSuffix, MessageHelper.messages["ERROR_PhoneTooLong"]);
				return false;
			}
			if(!MessageHelper.IsValidPhone(form[phone1].value)){
				displayErrorMessage(form[phone1].id + errorMsgSuffix, MessageHelper.messages["ERROR_INVALIDPHONE"]);
				return false;
			}
		}
		// Save RUT field value to zipcode field for Guest user
		else if(field == "guestIdentity" && userTypeCheckOut == "G") {			
			form[zipCode].value = trim(form[guestIdentity].value);
			
			var selectedIdentity = dojo.query('input[name="addressField1"]:checked')[0].value;
			if(selectedIdentity == 'RUT'){
				if(form[guestIdentity] != null && reWhiteSpace.test(form[guestIdentity].value) || form[guestIdentity].value == ""){ 
					displayErrorMessage(form[guestIdentity].id + errorMsgSuffix,MessageHelper.messages["ERROR_LogonIdEmpty"]); 
					return false;
				} 
			    if(!validateRut(form[zipCode].value)){ 
			    	displayErrorMessage(form[guestIdentity].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_RUT"]); 
					return false;
				}
			    form[zipCode].value = formatRut(trim(form[guestIdentity].value));
			}else{
				if(form[guestIdentity] != null && reWhiteSpace.test(form[guestIdentity].value) || form[guestIdentity].value == ""){ 
					displayErrorMessage(form[guestIdentity].id + errorMsgSuffix,MessageHelper.messages["CHECKOUT_ADDRESS_DNI_EMPTY"]); 
					return false;
				} 
				form[addressField3].value =  trim(form[guestIdentity].value);
				form[zipCode].value = "999999999";
			}
		}
		else if(field == "state"){
			var state = form[state];
			
			state.value = trim(state.value);
			
			// If default option seleted display the error message.
			if(state.selectedIndex == 0){
				displayErrorMessage(state.id + errorMsgSuffix, state.value);
				return false;
			}
			
			if(state.value == null || state.value == "" || reWhiteSpace.test(state.value)){
				displayErrorMessage(state.id + errorMsgSuffix, MessageHelper.messages["ERROR_StateEmpty"]);
				return false;
			}
			if(!MessageHelper.isValidUTF8length(state.value, 128)){
				displayErrorMessage(state.id + errorMsgSuffix, MessageHelper.messages["ERROR_StateTooLong"]);
				return false;
			}
		}
		else if(field == "city"){
			form[city].value = trim(form[city].value);
						
			if(form[city].value == "" || reWhiteSpace.test(form[city].value) || form[city].value =="Selecciona una comuna" )
			{ 
				displayErrorMessage(form[city].id + errorMsgSuffix, MessageHelper.messages["ERROR_ComunaEmpty"]);
				return false;
			}
			if(!MessageHelper.isValidUTF8length(form[city].value, 128)){
				displayErrorMessage(form[city].id + errorMsgSuffix, MessageHelper.messages["ERROR_ComunaTooLong"]);
				return false;
			}
		}
		else if(field == "address1"){
			// Street name in shipping address
			form[address1].value = trim(form[address1].value);
			if(form[address1].value == "" || reWhiteSpace.test(form[address1].value)){ 
				displayErrorMessage(form[address1].id + errorMsgSuffix, MessageHelper.messages["ERROR_AddressEmpty"]);
				return false;
			}
			isValid = validateAccentedCharacters(form["address1"].value,specialCharactersRegex1);
		    if(form[address1] != null && !isValid){ 
		    	displayErrorMessage(form[address1].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_CALLE"]); 
				return false;
			}		    
			if(!MessageHelper.isValidUTF8length(form[address1].value,100)){ 
				displayErrorMessage(form[address1].id + errorMsgSuffix, MessageHelper.messages["ERROR_AddressTooLong"]); 
				return false;
			}
			
		}else if(field == "address2"){
			// Building Number in shipping address
			form[address2].value = trim(form[address2].value);
			if(form[address2].value == "" || reWhiteSpace.test(form[address2].value)){ 
				displayErrorMessage(form[address2].id + errorMsgSuffix, MessageHelper.messages["ERROR_HouseNumEmpty"]);
				return false;
			}
			if(!MessageHelper.isValidUTF8length(form[address2].value, 7)){ 
				displayErrorMessage(form[address2].id + errorMsgSuffix, MessageHelper.messages["ERROR_HouseNumTooLong"]); 
				return false;
			}
			
		}
		else if(field == "country"){
			form[country].value = trim(form[country].value);
			if(form[country].value == "" || reWhiteSpace.test(form[country].value)){ 
				displayErrorMessage(form[country].id + errorMsgSuffix, MessageHelper.messages["ERROR_CountryEmpty"]);
				return false;
			}
			if(!MessageHelper.isValidUTF8length(form[country].value, 128)){ 
				displayErrorMessage(form[country].id + errorMsgSuffix, MessageHelper.messages["ERROR_CountryTooLong"]);
				return false;
			}
		}else if(field == "address3"){
			// Comments field in shipping address
			isValid = validateAccentedCharacters(form[address3].value,specialCharactersRegex2);
		    if(form[address3] != null && !isValid){ 
		    	displayErrorMessage(form[address3].id + errorMsgSuffix,MessageHelper.messages["ERROR_FACILITAR_TU_DESPACHO"]); 
				return false;
			}
		    if(document.getElementById('defaultShippingInfoText')){
				if(form[address3].value == document.getElementById('defaultShippingInfoText').value){ 
					form[address3].value = '';
				}
			}
		}
		else if (field == "addressflag"){
			form[addressFlag].value = trim(form[addressFlag].value);
			form[addressLatitude].value = trim(form[addressLatitude].value);
			form[addressLongitude].value = trim(form[addressLongitude].value);
		}
	}
	return true;
}
/* Validate Form CBS */

function ValidateFormCBS(id) {
	var useSavedToken=(dojo.byId('useSavedToken_'+id).value==='true');
	if(useSavedToken){
		return true;
	}
    var id= id;
    var InputName = 'name_on_card_'+id;
    var Inputlastname = 'lastname_on_card_'+id;
    var Inputcard = 'card_number_'+id;
    var Inputcard_expiry = 'card_expiry_date_'+id;
    var Inputcard_cvNumber = 'card_cvNumber_'+id;
    var errorMsgSuffix = "_errormsg";
    var text=/^[a-zA-Z]+$/;
    var number=/^[0-9]+$/;

   /* if (x.match(regex))
    if (!x.match(regex))*/

    var name = document.getElementById(InputName).value; 
    if (name == "") {
        displayErrorMessage(InputName+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_NAME"]);
        return false;
    }
    if(!isNaN(name)){
        displayErrorMessage(InputName+ errorMsgSuffix , MessageHelper.messages["ERROR_CBS_TEXT"]);
        return false;
    }

    var lastname = document.getElementById(Inputlastname).value; 
    if (lastname == "") {
        displayErrorMessage(Inputlastname+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_LASTNAME"]);
        return false;
    }
    if(!isNaN(lastname)){
        displayErrorMessage(Inputlastname+ errorMsgSuffix , MessageHelper.messages["ERROR_CBS_TEXT"]);
        return false;
    }

    /*Numeros*/
    var card = document.getElementById(Inputcard).value; 
    if (card == "") {
        displayErrorMessage(Inputcard+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_NUMBERCARD"]);
        return false;
    }  
    
    var result = "";
    if(id == '20'){
		/** T.cencosud Master and Visa/ 1149 Start **/    	
    	var splitValue = card.substring(0,8);
		var masterCard = 55920221, visaCard = 48907021;
		if( masterCard == splitValue ||  visaCard == splitValue ){
	    	var result = $("#card_number_20").validateCreditCard({
	            accept: ["visa", "mastercard"]
	    	});
		}else{
			var result = {valid : false};	
		}
    	/** T.cencosud Master and Visa/ 1149 End **/

    }else if(id == '99'){
    	var result = $("#card_number_99").validateCreditCard({
            accept: ["visa", "mastercard","amex"]
    	});
    }      
    if(!result.valid){
    	displayErrorMessage(Inputcard+ errorMsgSuffix , MessageHelper.messages["CYBER_SOURCE_CC_NUMBER_INVALID"]);
    	return false;
    }
    
    
    if(isNaN(card)){
        displayErrorMessage(Inputcard+ errorMsgSuffix , MessageHelper.messages["ERROR_CBS_NUMBER"]);
        return false;
    }
    var card_expiry = document.getElementById(Inputcard_expiry).value;
    if (card_expiry == "") {
        displayErrorMessage(Inputcard_expiry+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_DATEEXPIRATION"]);
        return false;
    }
    if (card_expiry.length < 5) {
        displayErrorMessage(Inputcard_expiry+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_DATEEXPIRATION"]);
        return false;
    }
    
    // get current year and month
    var d = new Date();
    var currentYear = d.getFullYear();
    var currentMonth = d.getMonth() + 1;
    // get parts of the expiration date
    var parts = card_expiry.split('-');
    var year = parseInt(parts[1], 10) + 2000;
    var month = parseInt(parts[0], 10);
    // compare the dates
    if (month > 12 || year < currentYear || (year == currentYear && month < currentMonth)) {
    	displayErrorMessage(Inputcard_expiry+ errorMsgSuffix , MessageHelper.messages["CYBER_SOURCE_EXP_DATE_INVALID"]);
        return false;        	
    }
    
    /*var card_expiry_value = document.getElementById(Inputcard_expiry).value;
    formatNumbers(card_expiry_value,Inputcard_expiry);*/

    var card_cv = document.getElementById(Inputcard_cvNumber).value; 
    if (card_cv == "") {
        displayErrorMessage(Inputcard_cvNumber+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_CODE"]);
        return false;
    }
    if (card_cv.length < 3) {
        displayErrorMessage(Inputcard_cvNumber+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_CODE"]);
        return false;
    }
    if(isNaN(card_cv)){
        displayErrorMessage(Inputlastname+ errorMsgSuffix , MessageHelper.messages["ERROR_CBS_NUMBER"]);
        return false;
    }
    
    return true;

}



/** T.cencosud Master and Visa/ 1149 Start **/

function numberCheck(id){
	var id = id;
	var Inputcard = 'card_number_'+id;
	var errorMsgSuffix = "_errormsg"; 
	var className = document.getElementById("btnCBSPagar_20").className;	 
	var hasClass = className.indexOf('disabled');	 

	/* t.cencosud Numeros */
	var card = document.getElementById(Inputcard).value; 	
	if (card == "") {
		displayErrorMessage(Inputcard+ errorMsgSuffix , MessageHelper.messages["ERROR_EMPTY_NUMBERCARD"]);
		return false;
	}  
	var result = "";	
	if(id == '20'){
		var splitValue = card.substring(0,8);
		var masterCard = 55920221, visaCard = 48907021;
		if( masterCard == splitValue ||  visaCard == splitValue ){			
			var result = $("#card_number_20").validateCreditCard({
				accept: ["visa", "mastercard"]
			});
		}
		else{
			result = {valid : false};	
		}
	}
	if(!result.valid){
		displayErrorMessage(Inputcard+ errorMsgSuffix , MessageHelper.messages["CYBER_SOURCE_CC_NUMBER_INVALID"]);
		/*document.getElementById('btnCBSPagar_20').style.pointerEvents = 'none';
		var className = document.getElementById("btnCBSPagar_20").className;
		var hasClass = className.indexOf('disabled');
		if(hasClass == -1){
			var d = document.getElementById("btnCBSPagar_20");
			d.className += "disabled";	    
		    
		}*/		 
		return false;
	}	 
	/*document.getElementById('btnCBSPagar_20').style.pointerEvents = 'auto';
	var className = document.getElementById("btnCBSPagar_20").className;
	var hasClass = className.indexOf('disabled');
	if(hasClass != -1){
		var el = document.getElementById("btnCBSPagar_20");	 
		var element = document.getElementById('btnCBSPagar_20');
		var remove_class = 'disabled';
		element.className = element.className.replace(' ' + remove_class, '').replace(remove_class, '');
		 
	}
	*/
	return true;
} 
/** T.cencosud Master and Visa/ 1149 END **/



function formatNumbers(id) {
    
    textBox = document.getElementById('card_expiry_date_'+id).value ;    
    var txt = textBox.replace(/-/g, '');
    Caracteres = txt.length;
    if(Caracteres == 3){
    	
    	document.getElementById('card_expiry_date_'+id).value = "0" + document.getElementById('card_expiry_date_'+id).value;
    	
       /* subCadena1 = txt.substring(2,0);
        subCadena2 = txt.substring(4,2);
         if(subCadena1){
            cadena = subCadena1+'-'+subCadena2;
            document.getElementById('card_expiry_date_'+id).value = cadena;
        }else{
            document.getElementById('card_expiry_date_'+id).value = '';
        }*/
    }
    /*else
    {
        document.getElementById('card_expiry_date_'+id).value = '';
    }*/
 }
    function soloLetras(e){
       key = e.keyCode || e.which;
       tecla = String.fromCharCode(key).toLowerCase();
       letras = " abcdefghijklmnopqrstuvwxyz";
       especiales = "8-37-39-46";

       tecla_especial = false
       for(var i in especiales){
            if(key == especiales[i]){
                tecla_especial = true;
                break;
            }
        }     
        if( key != '241'){
            if(letras.indexOf(tecla)==-1 && !tecla_especial){
               return false;
           }
        }
    }

    function soloNumeros(e){
       key = e.keyCode || e.which;
       tecla = String.fromCharCode(key).toLowerCase();
       letras = " 1234567890";
       especiales = "8-37-39-46";

       tecla_especial = false
       for(var i in especiales){
            if(key == especiales[i]){
                tecla_especial = true;
                break;
            }
        }

        if(letras.indexOf(tecla)==-1 && !tecla_especial){
            return false;
        }
    }
    function solofecha(e){
       key = e.keyCode || e.which;
       tecla = String.fromCharCode(key).toLowerCase();
       letras = " 1234567890-";
       especiales = "8-37-39-46";

       tecla_especial = false
       for(var i in especiales){
            if(key == especiales[i]){
                tecla_especial = true;
                break;
            }
        }

        if(letras.indexOf(tecla)==-1 && !tecla_especial){
            return false;
        }
    }

/*function fecha(input){
    
var num = input.value.replace(/\./g,'');
if(!isNaN(num)){
num = num.toString().split('').reverse().join('').replace(/(?=\d*\.?)(\d{3})/g,'$1.');
num = num.split('').reverse().join('').replace(/^[\.]/,'');
input.value = num;
    }
}*/


function fecha(donde,caracter){
    pat = /[\*,\+,\(,\),\?,\,$,\[,\],\^]/
    valor = donde.value
    largo = valor.length
    crtr = true
    if(isNaN(caracter) || pat.test(caracter) == true){
        if (pat.test(caracter)==true){ 
            caracter = '"\" + caracter'
        }
        carcter = new RegExp(caracter,"g")
        valor = valor.replace(carcter,"")
        donde.value = valor
        crtr = false
    }
    else{
        var nums = new Array()
        cont = 0
        for(m=0;m<largo;m++){
            if(valor.charAt(m) == "-" || valor.charAt(m) == " ")
                {continue;}
            else{
                nums[cont] = valor.charAt(m)
                cont++
            }
        }
    }
    var cad1="",cad2="",tres=0
   //alert(cad1);
    if(largo > 2 && crtr == true){
        for (k=nums.length-1;k>=0;k--){
            cad1 = nums[k]
            cad2 = cad1 + cad2
            tres++
            if((tres%2) == 0){
                if(k!=0){
                    cad2 = "-" + cad2
                }
            }
        }
        donde.value = cad2
    }
}   


    /*var name_on_card_ = document.forms["fieldsAreaSection"]["name_on_card_"].value;


/*    var sAux="";
    var frm = document.getElementById("Inputcard_expiry");
    for (i=0;i<frm.elements.length;i++)
    {
        sAux += "NOMBRE: " + frm.elements[i].name + " ";
        sAux += "TIPO :  " + frm.elements[i].type + " "; ;
        sAux += "VALOR: " + frm.elements[i].value + "\n" ;
    }
    alert(sAux);

var fields = form["fieldsAreaSection"].value.split(",");     

 var factura = document.getElementById('numeroFactura-' + [i]).value;

var input = $('input[type=text]');
alert(fields);
if (input.val() == ""){
alert("un campo qued vaco");
}else{
// Ejecutar cdigo de insercin
}*/

// To display the form error message for respective input elements
function displayErrorMessage(id,message){
	dojo.byId(id).innerHTML = message;	
	dojo.byId(id).style.display = "block";
	if(id.indexOf('_errormsg') > 0){
		var newid = id.split('_errormsg');
		if(dojo.byId(newid[0]))
			dojo.byId(newid[0]).focus();
	}else{
		dojo.byId(id).focus();
	}
	var hideMessage = function(){hideAndClearMessage(id);};
	setTimeout(hideMessage, 3000);
}

// To hide/clear the error message for the input elements
function hideAndClearMessage(id){
	dojo.byId(id).innerHTML = "";
	dojo.byId(id).style.display = "none";
}

// This function used in MessageHelper.js while displaying server error messages.
function hideOverView(){
	if(dojo.byId('global_overlay')){
		var overlay = dojo.byId('global_overlay');
		dojo.style(overlay,'display','none');	
	}else{
		console.debug('Could not find id: global_overlay');
	}
}
/*Open and Close Modal Address*/
function OpenModal(type,addressId) {
	// Fetch the guestRut,RegUserRut and Email from the shippingDetailsAreaContext
	var renderContext = wc.render.getContextById("shippingDetailsAreaContext"); 
	var email = renderContext.properties['userEmail'];
	var guestRut = renderContext.properties['guestRUT'];
	var regUserRut = renderContext.properties['regUserRUT'];
	// Call ajax refresh handler to refresh the shipaddress form
	wc.render.updateContext("shippingAddressAreaAddEditContext",{"addressId":addressId,"type":type,"orderId":SinglePageCheckoutJS.orderId,"email1":email,"guestRUT":guestRut,"regUserRUT":regUserRut});	
}
function CloseModal(){
	dojo.removeClass(dojo.byId("checkoutShippingAddressForm"),'ModalDesktop');
	//dojo.byId("checkoutShippingAddressForm").classList.remove("ModalDesktop");
	dojo.byId("checkoutShippingAddressForm").className = "hide";
	dojo.removeClass(dojo.byId("shippingAddressFormContainer"),'modal-contenido');
	//dojo.byId("shippingAddressFormContainer").classList.remove("modal-contenido");
	dojo.removeClass(dojo.byId("imgCerrar"),'CerrarIcono');
	//dojo.byId("imgCerrar").classList.remove("CerrarIcono");
	dojo.addClass(dojo.byId("heading_close"),'OcultaHeader');
	//dojo.byId("heading_close").classList = ('OcultaHeader');
	dojo.removeClass(dojo.byId("shipAddress_desc"),'OcultaHeader');
	//dojo.byId("shipAddress_desc").classList.remove('OcultaHeader');	
}


// This function to switch between three different despacho option
function switchDeliveryOption(evt, option) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(option).style.display = "block";
    evt.currentTarget.className += " active";    
    
    // when user switch between tabs show / hide the order item grouping
    if(option != SinglePageCheckoutJS.selectedDeliveryOption && dojo.byId('checkout_orderitem_groups')){
    	dojo.byId('checkout_orderitem_groups').className = "hide";
    	// If only one ship address exist, enable the continue button
    	if(dojo.byId('single_ship_address_list')){
    		dojo.byId('checkout_ship_address_continue').className = "show";
    	}
    }else if(option == SinglePageCheckoutJS.selectedDeliveryOption && dojo.byId('checkout_orderitem_groups')){
    	dojo.byId('checkout_orderitem_groups').className = "show";
    }
    
    /*if(option == 'TabChileExpress'){
    	document.getElementById('checkout_CE_address').style.display = "none";
    	document.getElementById('checkoutCEDetails').style.display = "none";
    }*/
}
/*Accordion for Mobile changed tabs of mobile*/
/*hidde box*/
function HideBox(id){
    
    /*alert(id);*/
    if(id == 'AccordionDespachoMo'){
        document.getElementById("UnselectedTabDespacho2").classList.remove("hide");
        document.getElementById("AccordionDespachoMo").classList.remove("mobile"); 
        document.getElementById("AccordionDespachoMo").className += " hide"; 
        document.getElementById('shipping_order_details').style.display = "none";
        document.getElementById('TabDespacho').style.display = "none";    
    }
    if(id == 'AccordionNovio'){       
        document.getElementById("UnselectedNovio").classList.remove("hide");
        document.getElementById("AccordionNovio").classList.remove("mobile"); 
        document.getElementById("AccordionNovio").className += " hide";         
        document.getElementById('shipping_order_details').style.display = "none";       
        document.getElementById('TabNovio').style.display = "none";  
    }
    if(id == 'AccordionRetiro'){       
        document.getElementById("UnselectedRetiro").classList.remove("hide");
        document.getElementById("AccordionRetiro").classList.remove("mobile"); 
        document.getElementById("AccordionRetiro").className += " hide";         
        document.getElementById('shipping_order_details').style.display = "none";       
        document.getElementById('TabRetiroEnTienda').style.display = "none";  
    }  
    if(id == 'AccorChileExpress'){       
        document.getElementById("UnselectedChileExpress").classList.remove("hide");
        document.getElementById("AccorChileExpress").classList.remove("mobile"); 
        document.getElementById("AccorChileExpress").className += " hide";         
        document.getElementById('shipping_order_details').style.display = "none";       
        document.getElementById('TabChileExpress').style.display = "none";  
    }  
}

/*Retiro No Activo*/
function ShowRetiroBox(event, tab){ 
        switchDeliveryOption(event, tab);
        document.getElementById("UnselectedTabDespacho").classList.remove("hide");
        document.getElementById("AccordionDespachoMo").classList.remove("mobile");      
        document.getElementById("AccordionDespachoMo").className += " hide"; 
        document.getElementById("UnselectedTabDespacho2").className += " hide"; 
        document.getElementById("AccordionNovio").className += " hide";
        document.getElementById("UnselectedNovio").classList.remove("hide");
        document.getElementById('shipping_order_details').style.display = "block"; 

        var element5 = document.getElementById("UnselectedRetiro");
        if (element5 != null ) { 
            document.getElementById("AccordionRetiro").classList.remove("hide");
            document.getElementById("UnselectedRetiro").className += " hide";
            document.getElementById("UnselectedRetiro2").className += " hide";
            document.getElementById("UnselectedRetiro").className += " hide";
            document.getElementById("UnselectedRetiro").classList.remove("mobile"); 
        }

        var element6 = document.getElementById("AccorChileExpress");  
        var element7 = document.getElementById("UnselectedChileExpress");  
        var element8 = document.getElementById("UnselectedChileExpress2");  
        if (element6 != null || element7 != null || element8 != null) {
            document.getElementById("UnselectedChileExpress2").classList.remove("hide");  
            document.getElementById("AccorChileExpress").className += " hide"; 

            /*document.getElementById("UnselectedTabDespacho3").className += " hide"; 
            document.getElementById("UnselectedRetiro3").className += " hide";*/
            
        }

        AnchorScroll('#AccordionRetiro');

}

/*ChileExpress No Activo*/
function ShowChileExpressBox(event, tab){ 
        switchDeliveryOption(event, tab);

        document.getElementById("AccorChileExpress").classList.remove("hide");
        document.getElementById("UnselectedChileExpress").classList.remove("mobile"); 
        document.getElementById("UnselectedChileExpress").className += " hide"; 
        document.getElementById("UnselectedTabDespacho2").className += " hide"; 
        document.getElementById('shipping_order_details').style.display = "block";
        document.getElementById("UnselectedChileExpress").className += " hide"; 
        //document.getElementById("UnselectedTabDespacho").classList.remove("hide");
        document.getElementById("AccordionDespachoMo").className += " hide"; 
        document.getElementById("UnselectedTabDespacho3").classList.remove("hide");

        var element4 = document.getElementById("AccordionNovio");
        if (element4 != null ) {
            document.getElementById("AccordionNovio").className += " hide"; 
            document.getElementById("UnselectedChileExpress2").className += " hide"; 
            document.getElementById("UnselectedNovio").classList.remove("hide");            
        }

        var element5 = document.getElementById("UnselectedRetiro");
        if (element5 != null ) { 
            document.getElementById("UnselectedRetiro").classList.remove("mobile");
            document.getElementById("UnselectedRetiro").className += " hide";
            document.getElementById("UnselectedRetiro2").className += " hide";
            document.getElementById("AccordionRetiro").className += " hide";
            document.getElementById("UnselectedRetiro").classList.remove("mobile"); 
           /* document.getElementById("AccordionRetiro").classList.remove("hide");
            document.getElementById("UnselectedRetiro3").classList.remove("hide");*/
        }        

        AnchorScroll('#AccorChileExpress');

}


/*Despacho No Activo*/
function ShowDespachoBox(event, tab){
    switchDeliveryOption(event, tab);
    var element1 = document.getElementById("UnselectedTabDespacho"); 
    if (element1 != null) {
        document.getElementById("UnselectedTabDespacho").className += " hide"; 
    }          
    document.getElementById("AccordionDespachoMo").classList.remove("hide");
    document.getElementById("UnselectedTabDespacho2").className += " hide"; 
    document.getElementById("AccordionNovio").className += " hide";
    document.getElementById("UnselectedNovio").classList.remove("hide");     
    document.getElementById('shipping_order_details').style.display = "block";
    var element5 = document.getElementById("AccordionRetiro"); 
    if (element5 != null) {
        document.getElementById("AccordionRetiro").className += " hide"; 
        document.getElementById("UnselectedRetiro2").className += " hide";
        document.getElementById("UnselectedRetiro").classList.remove("hide");
    } 

    var element6 = document.getElementById("AccorChileExpress");  
    var element7 = document.getElementById("UnselectedChileExpress2");  

    
    if (element6 != null) {
        document.getElementById("AccorChileExpress").className += " hide"; 
        document.getElementById("UnselectedTabDespacho3").className += " hide";
        document.getElementById("UnselectedChileExpress").classList.remove("hide"); 
      
    }
    if (element7 != null) {
        document.getElementById("AccorChileExpress").className += " hide";
        document.getElementById("UnselectedChileExpress2").className += " hide";
        document.getElementById("UnselectedChileExpress").classList.remove("hide"); 
    }

    AnchorScroll('#AccordionDespachoMo');

}

/*Novio No Activo*/
function ShowNovioBox(event, tab){
    switchDeliveryOption(event, tab);
    document.getElementById("UnselectedNovio").classList.remove("mobile");
    document.getElementById("UnselectedNovio").className += " hide";
    document.getElementById("AccordionDespachoMo").classList.remove("mobile");   
    document.getElementById("AccordionDespachoMo").className += " hide";
    document.getElementById("AccordionNovio").classList.remove("hide");
    document.getElementById('shipping_order_details').style.display = "block";

    var element4 = document.getElementById("UnselectedTabDespacho"); 
    if (element4 != null) {
        document.getElementById("UnselectedTabDespacho").className += " hide"; 
    }
    document.getElementById("UnselectedTabDespacho2").classList.remove("hide");   
    var element5 = document.getElementById("UnselectedRetiro"); 
    if (element5 != null) {
        document.getElementById("UnselectedRetiro").classList.remove("mobile");  
        document.getElementById("UnselectedRetiro").className += " hide"; 
        document.getElementById("AccordionRetiro").className += " hide"; 
        document.getElementById("UnselectedRetiro2").classList.remove("hide");    
    } 

    var element6 = document.getElementById("UnselectedChileExpress"); 
    var element7 = document.getElementById("UnselectedChileExpress2"); 

    if (element6 != null ) { 

        document.getElementById("AccorChileExpress").className += " hide";  
        document.getElementById("UnselectedChileExpress2").classList.remove("mobile"); 
        document.getElementById("UnselectedChileExpress2").classList.remove("hide"); 
        document.getElementById("UnselectedChileExpress").className += " hide";
        document.getElementById("UnselectedChileExpress").classList.remove("mobile");

    }
    var element8 = document.getElementById("UnselectedTabDespacho3");     
    if (element8 != null ) { 
        document.getElementById("UnselectedTabDespacho3").className += " hide"; 
    }
    
    AnchorScroll('#AccordionNovio');

}

/*Scroll hidden Modal*/
function AnchorScroll(ID){
    $('html, body').animate({scrollTop: $(ID).offset().top}, 500);
}
function reloadScrollBars() {
    document.documentElement.style.overflow = 'auto';  // firefox, chrome
    document.body.scroll = "yes"; // ie only
}

function unloadScrollBars() {
    document.documentElement.style.overflow = 'hidden';  // firefox, chrome
    document.body.scroll = "no"; // ie only
}


// This function to initialize the shipping details ajax refresh area and url
function initShippingDetailsRefreshArea(){
	SinglePageCheckoutJS.setControllerURL('shippingAddressAreaAddEditController',dojo.byId('CheckoutShipAddressFormURL').value);
    SinglePageCheckoutJS.setControllerURL('shippingAddressListController',dojo.byId('CheckoutShipAddressListURL').value);
    SinglePageCheckoutJS.setControllerURL('orderItemDetailsAreaController',dojo.byId('CheckoutOrderItemDetailsURL').value);
    SinglePageCheckoutJS.setControllerURL('selectedPhysicalStoreAreaController',dojo.byId('CheckoutPhysicalStoreDetailsURL').value);
    SinglePageCheckoutJS.setControllerURL('NoviosSearchFormController',dojo.byId('CheckoutNoviosSearchFormURL').value);
    SinglePageCheckoutJS.setControllerURL('noviosSearchResultsAreaController',dojo.byId('CheckoutNoviosSearchResultsURL').value);
    SinglePageCheckoutJS.setControllerURL('selectedNoviosAddressAreaController',dojo.byId('CheckoutNoviosAddressDetailsURL').value);
    SinglePageCheckoutJS.setControllerURL('selectPhysicalStoreAreaController',dojo.byId('CheckoutPhysicalStoreListURL').value);
    SinglePageCheckoutJS.setControllerURL('selectPhysicalOfficeAreaController',dojo.byId('CheckoutPhysicalOfficeListURL').value);
    SinglePageCheckoutJS.setControllerURL('selectedPhysicalCEStoreAreaController',dojo.byId('CheckoutPhysicalOfficeDetailsURL').value);
	parseWidget("shippingAddressAddEditArea");
    parseWidget("shippingAddressListArea");
    parseWidget("orderItemDetailsArea");
    if(dojo.byId('selectedPhysicalStoreArea')){
    	parseWidget("selectedPhysicalStoreArea");
    }
    if(dojo.byId('selectPhysicalStoreArea')){
    	parseWidget("selectPhysicalStoreArea");
    }
    if(dojo.byId('selectPhysicalCEStoreArea')){
    	parseWidget("selectPhysicalCEStoreArea");
    }
    if(dojo.byId('selectedPhysicalCEStoreArea')){
    	parseWidget("selectedPhysicalCEStoreArea");
    }
    parseWidget("NoviosSearchForm");
    parseWidget("noviosSearchResultsArea");
    parseWidget("selectedNoviosAddressArea");

}

// This function to hide the different checkout sections
function displayCheckoutArea(id,flag){
	var header = dojo.query("#"+ id + ' #box_header')[0];
	var headerNumber = dojo.query("#"+ id + ' #box_header .box_number >span')[0];
	var headerImage = dojo.query("#"+ id + ' #box_header .box_number >span')[1];
	var content = dojo.query("#"+ id + ' #box_content')[0];
	if(flag == 'disable'){
		header.className = "Completed DisableHeader";
		headerNumber.className = "hide";
		headerImage.className = "show";			
		content.className = "hide";		
	} else if(flag == 'editlogon'){
		header.className = "DisableHeader";
		headerNumber.className = "show";
		headerImage.className = "hide";			
		content.className = "hide";
	}else {
		header.className = "";
		headerImage.className = "hide";	
		headerNumber.className = "show";						
		content.className = "";		
	}
}

// Function to open the step 2 (shipping option) to edit
function editShippingOptions(){
	// Hide Step 3
	var id = "checkout_billingdetails";
	var header = dojo.query("#"+ id + ' #box_header')[0];
	var headerNumber = dojo.query("#"+ id + ' #box_header .box_number >span')[0];
	var headerImage = dojo.query("#"+ id + ' #box_header .box_number >span')[1];
	var content = dojo.query("#"+ id + ' #box_content')[0];
	dojo.byId('checkout_billingdetails').className = "";
	header.className = "DisableHeader";
	headerImage.className = "hide";	
	headerNumber.className = "show";						
	content.className = "hide";
	
	if(SinglePageCheckoutJS.selectedDeliveryOption == ""){
		wc.render.updateContext("shippingDetailsAreaContext", {"orderId":SinglePageCheckoutJS.orderId} );
	}else{
		// Show Step 2
		dojo.query('#checkout_orderdetails .EditSection')[0].className="EditSection hide";
		dojo.query('#checkout_orderdetails .shipping_text')[0].className="shipping_text hide";
		
		// Refresh Step2: Novios Search Form
		wc.render.updateContext("NoviosSearchFormContext",{"orderId":SinglePageCheckoutJS.orderId});
		
		// Enable step 2
		displayCheckoutArea('checkout_orderdetails','enable');
	}	
	AnchorScroll("#checkout_orderdetails");
}

// This function to call Giftinfoupdate service call 
function updateGiftRegistrantAddressForItemsExt(params,addressId){
	if(addressId==-3){
		delete params['addressId'];
		params["shipToRegistrant"]="1";
	}else{
		params["shipToRegistrant"]="0";
		//CheckoutHelperJS.shipmentTypeId= "1";
	}
	//cursor_wait();
	wc.service.invoke("AjaxOrderChangeServiceGiftInfoUpdate", params);  
	//cursor_clear();
	return params;
}

// This function to add/delete warranty item when user selec/deselect the warranty option from the check box
function processWarrantyCheckBox(orderItemIdFrom, qty, catEntryIdTo, warrantyYears, warrantyType) {
	var checkBox =  document.getElementById("warranty_check_for_" + orderItemIdFrom);
	
	setCurrentId("warranty_check_for_" + orderItemIdFrom);
	
	if(checkBox.checked) {
		var params = [];
		params.isWarrantyItem = true;
		params.orderItemIdFrom = orderItemIdFrom;
		
		if(null != warrantyType) {
			params.guaranteeType = warrantyType;
		}
		if(null != warrantyYears) {
			params.warrantyYears = warrantyYears;
		}
		if(qty == null || qty == ""){
			qty = 1; 
		}
		
		SinglePageCheckoutJS.AddItem2ShopCartAjax(catEntryIdTo, qty, params);		
	} else {
		
		var warrantyOrderItemId = document.getElementById("warranty_check_for_" + orderItemIdFrom).value;
		SinglePageCheckoutJS.deleteWarrantyFromCart(warrantyOrderItemId);
	}
}

// This function to add/delete warranty item when user selec/deselect the warranty option from the popup
function getWarrantySelected(orderItemIdFrom, orderItemIdTo) {	
	
	var selectedWarrantyOption = dojo.query('input[type=radio]:checked',dojo.query('.checkoutWarrantyModal')[0])[0];
	
	if(selectedWarrantyOption.value=="sinGarantia") {   
		
		if(null != orderItemIdTo && orderItemIdTo != 'undefined' &&  "" != orderItemIdTo) {			       		
			SinglePageCheckoutJS.deleteWarrantyFromCart(orderItemIdTo);  //delete the warranty orderitem record			
		}else {	
			closeWarrantyModal();
			return false;     //just close the modal, as first time modal with a default: sin garantia.
		}
  	} else {     
		//For all warranty objects, do the else.	        		
       	var catentryObject= selectedWarrantyOption.value.split(",");
    	//parsing each elements
    	var orderItemIdFrom = parseInt(catentryObject[0]);
    	var qty = parseFloat(catentryObject[1]);
    	var catEntryIdTo = parseInt(catentryObject[2]);
    	var warrantyYears = parseInt(catentryObject[3]);
    	var addressId = catentryObject[5].replace(/\s/g,'');
    	var warrantyType = catentryObject[4].replace(/\s/g,'');
    	
    	processWarrantyRadio(orderItemIdFrom, qty, catEntryIdTo, warrantyYears, warrantyType, addressId);
	} //else end
	    	
}

// This function to open the warranty modal
function openWarrantyModal(orderItemId){
	if(dojo.byId('ModalWarranty_'+orderItemId)){
		
		// To open the warranty modal
		dojo.byId('ModalWarranty_'+orderItemId).className = 'checkoutWarrantyModal';
		
		// To select the default option
		if(dojo.query('[data-checked]',dojo.query('.checkoutWarrantyModal')[0]).length > 0){
			dojo.query('[data-checked]',dojo.query('.checkoutWarrantyModal')[0])[0].checked = true;
		}else{
			dojo.query('.sinGarantia',dojo.query('.checkoutWarrantyModal')[0])[0].checked = true;
		}
		
		// To block the scroll bar of the page
		unloadScrollBars();
	}
	
}

// This function toclose the warranty modal
function closeWarrantyModal(){
	dojo.query('.checkoutWarrantyModal').forEach(function(element){        		
		element.className = 'hide';	
		reloadScrollBars();
	});
}

// This function to process the selected warranty item information
function processWarrantyRadio(orderItemIdFrom, qty, catEntryIdTo, warrantyYears, warrantyType) {
	var checkBox =  document.getElementById("warranty_check_for_" + orderItemIdFrom);
	if(checkBox.checked) {
		document.getElementById("warrantyItemOrderItemIDFrom").value = orderItemIdFrom;
		var warrantyOrderItemId = document.getElementById("warranty_check_for_" + orderItemIdFrom).value;
		setCurrentId("warranty_check_for_" + orderItemIdFrom);
		SinglePageCheckoutJS.changeWarrantyItemInCart(warrantyOrderItemId, catEntryIdTo, warrantyYears, warrantyType);
	}else{
		checkBox.checked = true;
		processWarrantyCheckBox(orderItemIdFrom, qty, catEntryIdTo, warrantyYears, warrantyType);
	}
}
// This function to validate the novios input
function noviosCallback(e,node) {
	if(	e.keyCode==dojo.keys.ENTER||e.keyCode==dojo.keys.BACKSPACE){
	return;
	}
	var regex = /^\w+|\'+|\-+|+|+$/;
    if(node.id==='externalId'){
	regex = /^\d+$/;
    }
	var key = String.fromCharCode(!e.charCode ? e.which : e.charCode);
    if(key===undefined || key===''){
    return;
    }
	
    var test=regex.test(key);
    if (!test) {
       e.preventDefault();
       return false;
    }
}

//Function to enable novios no-results area and hide results area
function displayNoviosSearchResultArea(flag){
	if(flag == 'error'){
		dojo.byId('novios_results_area').className = "BoxResult show";
		dojo.byId('novios_no_results').className = "BoxNoResults show";
		dojo.byId('novios_results').className = "divTable hide";
	}else if(flag == 'submit'){
		dojo.byId('novios_results_area').className = "BoxResult hide";
	}else if(flag == 'success'){
		dojo.byId('novios_results_area').className = "BoxResult show";
		dojo.byId('novios_no_results').className = "BoxNoResults hide";
		dojo.byId('novios_results').className = "divTable show";
	}
    if(flag=='error' || flag=='success'){
        AnchorScroll("#checkout_novios_results_area");
    }		
}
// To limit the input text length
function limitText(theField, maxLen) 
{
	if (theField.value.length > maxLen) 
	{
		theField.value = theField.value.substring(0, maxLen);
	}
}

// To validate the giftcard form
function validateGiftcardForm(form){
      var giftCardNumber = form.giftCardNumber
      var password = form.password
      var TRUT = form.TRUT;
      var errorMsgDiv = "giftcard_form_errorMessage";
      
      if(null != giftCardNumber && giftCardNumber.value === ""){
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["MISSING_GIFT_CARD_NUM"]);
    	  return false;
      }
      if (giftCardNumber.value.length != 16) {
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["INVALID_GIFT_CARD_NUM"]);
    	  return false;
      }
      if (!MessageHelper.IsNumeric(giftCardNumber.value)) {
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["GIFTCARD_OR_CLAVE_NUMERIC"]);
    	  return false;   	  
      }
      if(null != password && password.value === ""){
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["MISSING_GIFT_CARD_CLAVE"]);
          return false;
      }
      if (password.value.length != 4) {
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["INVALID_GIFT_CARD_CLAVE"]);
          return false;
      }
      if (!MessageHelper.IsNumeric(password.value)) {
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["GIFTCARD_OR_CLAVE_NUMERIC"]);
    	  return false;   	  
      }
      if(null != TRUT && TRUT.value === ""){
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["MISSING_GIFT_CARD_TRUT"]);
          return false;
      }
      if(!validateRut(TRUT.value)){
    	  displayErrorMessage(errorMsgDiv, MessageHelper.messages["ERROR_INVALID_RUT"]);
          return false;
      }
      return true;
}

function isValidFacturaForm(facturaForm) {
	reWhiteSpace = new RegExp(/^\s+$/);
	specialCharactersRegex1 = new RegExp(/^[A-Za-z0-9_\s.,-\/]/);
	specialCharactersRegex2 = new RegExp(/^[A-Za-z0-9_!?,.()@$"#?\s&\/%-]/);
	specialCharactersRegex3 = new RegExp(/^[A-Za-z0-9_.\-\s]/);
    isValid = true;
    
    // Error Message Field
	var errorMsgSuffix = "_errormsg"
	
	if(facturaForm['empresa'].value == "" || reWhiteSpace.test(facturaForm['empresa'].value)){ 
		displayErrorMessage(facturaForm['empresa'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_EMPRESA"]);
		return false;
	}
	isValid = this.validateAccentedCharacters(facturaForm['empresa'].value,specialCharactersRegex1);
    if(facturaForm['empresa'] != null && !isValid){
    	displayErrorMessage(facturaForm['empresa'].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_EMPRESA"]); 
		return;
	}
	if(facturaForm['rut'].value == "" || reWhiteSpace.test(facturaForm['rut'].value)){ 
		displayErrorMessage(facturaForm['rut'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_RUT"]);
		return false;
	}
	if(!validateRut(facturaForm['rut'].value)){ 
		displayErrorMessage(facturaForm['rut'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_INVALID_RUT"]);
		return false;
	}
	if(facturaForm['razonsocial'].value == "" || reWhiteSpace.test(facturaForm['razonsocial'].value)){ 
		displayErrorMessage(facturaForm['razonsocial'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_RAZON_SOCIAL"]);
		return false;
	}
	isValid = this.validateAccentedCharacters(facturaForm['razonsocial'].value,specialCharactersRegex1);
    if(facturaForm['razonsocial'] != null && !isValid){
    	displayErrorMessage(facturaForm['razonsocial'].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_RAZON_SOCIAL"]); 
		return;
	}
	if(facturaForm['giro'].value == "" || reWhiteSpace.test(facturaForm['giro'].value)){ 
		displayErrorMessage(facturaForm['giro'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_GIRO"]);
		return false;
	}
	isValid = this.validateAccentedCharacters(facturaForm['giro'].value,specialCharactersRegex1);
    if(facturaForm['giro'] != null && !isValid){
    	displayErrorMessage(facturaForm['giro'].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_GIRO"]); 
		return;
	}
  
    //Region Validation in Factura
	if(facturaForm['state'].value =="" ||  facturaForm['state'].selectedIndex == 0)
    {
		displayErrorMessage(facturaForm['state'].id + errorMsgSuffix, facturaForm['state'].value); 
		return;
	}
    
    //Comuna Validation in Factura
	if(facturaForm['city'].value =="" ||  facturaForm['city'].value =="Selecciona una comuna")
    {
		displayErrorMessage(facturaForm['city'].id + errorMsgSuffix,MessageHelper.messages["ERROR_ComunaEmpty"]); 
		return;
	}
    
	if(facturaForm['direccion'].value == "" || reWhiteSpace.test(facturaForm['direccion'].value)){ 
		displayErrorMessage(facturaForm['direccion'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_DIRECCION"]);
		return false;
	}
	isValid = this.validateAccentedCharacters(facturaForm['direccion'].value,specialCharactersRegex1);
    if(facturaForm['direccion'] != null && !isValid){
    	displayErrorMessage(facturaForm['direccion'].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_DIRECCION"]); 
		return;
	}	
	
	if(facturaForm['telefono1'].value == "" || reWhiteSpace.test(facturaForm['telefono1'].value)){ 
		displayErrorMessage(facturaForm['telefono1'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_TELEFONO"]);
		return false;
	}
	if(!MessageHelper.IsValidPhone(facturaForm['telefono1'].value)){
		displayErrorMessage(facturaForm['telefono1'].id + errorMsgSuffix, MessageHelper.messages["ERROR_INVALIDPHONE"]);
		return false;
	}
	if(facturaForm['contacto'].value == "" || reWhiteSpace.test(facturaForm['contacto'].value)){ 
		displayErrorMessage(facturaForm['contacto'].id + errorMsgSuffix, MessageHelper.messages["BILLING_FACTURA_EMPTY_CONTACTO"]);
		return false;
	}
	isValid = this.validateAccentedCharacters(facturaForm['contacto'].value,specialCharactersRegex3);
    if(facturaForm['contacto'] != null && !isValid){
    	displayErrorMessage(facturaForm['contacto'].id + errorMsgSuffix,MessageHelper.messages["ERROR_INVALID_CONTACTO"]); 
		return;
	}
	return true;
}


// To remove the progress bar
function removeProgressBar(){
	//cursor_clear();
	setTimeout('cursor_clear()',500);
	reloadScrollBars();
}
// To Open the progressbar
function openProgressBar(){
	displayProgressBar();	
	unloadScrollBars();
}

// To reset the DaD section to default
function resetDaD(){		
	dojo.query('input[type=radio][name=select_ship_address]').forEach(function(element){        		
		element.checked = false;
		element.disabled = false;	
	});
}
// To reset the ReT section to default
function resetReT(){
	if(dojo.byId('checkoutReTDetails')){
		// Hide ReT Details area
		dojo.byId('checkoutReTDetails').className = "hide";
	}
	if(dojo.byId('checkoutReTForm')){
		// Display the zona and store drop down
		dojo.byId('checkoutReTForm').className = "show";
	    dojo.byId('list_zonaname').selectedIndex=0;
		SinglePageCheckoutJS.loadPhysicalStores('1');
		dojo.byId('checkout_ret_continue').className = "button disabled";
	}	
	if(dojo.byId('proxy_checkbox')){
		dojo.byId('proxy_checkbox').checked = false;
		dojo.byId('proxy_firstName').value = "";
		dojo.byId('proxy_lastName').value = "";
	}

}
//To reset the CE section to default
function resetCE(){
	/*if(dojo.byId('checkout_CE_address')){
		// Hide CE Address area
		dojo.byId('checkout_CE_address').className = "hide";
	}*/
	if(dojo.byId('checkoutCEDetails')){
		// Hide CE Details area
		dojo.byId('checkoutCEDetails').className = "hide";
	}
	if(dojo.byId('checkoutCEForm')){
		// Display the zona and store drop down
		dojo.byId('checkoutCEForm').className = "show";
	    dojo.byId('list_regionname').selectedIndex=0;
		SinglePageCheckoutJS.loadPhysicalOffices('1');
		dojo.byId('checkout_chileExp_continue').className = "button disabled";
	}	
}
// To reset the Novios section to default
function resetNovios(){
	// display the novios search form
	dojo.byId('select_novios_address').className = "show";
	// hide the selected novios area
	dojo.byId('checkout_novios_address_detail').className = "hide";	
	dojo.addClass(dojo.byId('novios_results_area'),'hide');
	var noviosSearchForm = document.forms['search_registry']; 
	noviosSearchForm['externalId'].value="";
	noviosSearchForm['firstName'].value="";
	noviosSearchForm['lastName'].value="";
}
/** End: Common funtions used in different method **/

/** TO DO - Begin: Extended Progress bar: Need to remove after implementing checkout progress bar**/


/**
 * Displays the progress bar dialog to indicate a request is currently running.
 * There are certain cases where displaying the progress bar causes problems in Opera,
 * the optional parameter "checkForOpera" is passed to specifically check if the browser used is Opera,
 * if so, do not display the progress bar in these cases.
 *
 * @param {boolean} checkForOpera Indicates whether to check if the browser is Opera or not.
 */
function ext_cursor_wait(checkForOpera) {
	var showPopup = true;	

	//Since dijit does not support Opera
	//Some progress bar dialog will be blocked in Opera to avoid error
	if(checkForOpera == true){
		if(dojo.isOpera > 0){
			showPopup = false;
		}
	}
	
	//For all other browsers and pages that work with Opera
	//Display the progress bar dialog
	if(showPopup){
		//Delay the progress bar from showing up
		setTimeout('ext_showProgressBar()',500);
	}
}

/**
 * Helper method for cursor_wait() to display the progress bar pop-up.
 * Displays progress bar, next to the element if the element id was specified in currentId,
 * or defaults to the center of the page if currentId is empty.
 * Progress bar will only be displayed if the submitted request has not been completed.
 * This method is only called implicitly by the cursor_wait() method, which is triggered before a request is submitted.
 */
function ext_showProgressBar(){
	//After the delay, if the request is still not finished
	//Then continue and show the progress bar
	//Otherwise, do not execute the following code
	if(!requestSubmitted){
		return;
	}
	
	ext_displayProgressBar();
	
}


/**
 * Helper method for showProgressBar() to display the progress bar pop-up.
 * It can also be forced to show the progress bar directly in special cases.
 * The function also displays the progress bar next to the element if the element id was specified in currentId,
 * or defaults to the center of the page if currentId is empty.
 * This method can be called implicitly by the cursor_wait() method or explicitly by itself.
 */
function ext_displayProgressBar(){
	var dialog = dijit.byId('ext_progress_bar_dialog');
	
	//Make sure the dialog is created
	if(dialog != null){
			
		//Hide the header for the close button
		dialog.closeButtonNode.style.display='none';		
		
		var progressBar = document.getElementById('ext_progress_bar');
		progressBar.style.display = 'block';	
				
		//Check whether or not an element ID is provided
		//If yes, point the progress bar to this element
		//Otherwise, show the progress bar in a dialog
		if(this.currentId != ""){
			var element = document.getElementById(this.currentId);	
			var pos = dijit.placeOnScreenAroundElement(progressBar,element,{'TR':'TL'});	
		} else {
			dialog.containerNode.innerHTML == "";
			progressBar.style.left = '';
			progressBar.style.top = '';
			dialog.containerNode.appendChild(progressBar);
			dialog.show();		
		}
		
		//Make sure the progress bar dialog goes away after 30 minutes
		//and does not hang if server calls does not return
		//Assuming the longest server calls return before 30 minutes
		setTimeout("ext_cursor_clear()",1800000);
	}
}

/**
 * Hides the progress bar dialog when the submitted request has completed.
 * Set the visibility of the progress bar dialog to hide from the page.
 */
function ext_cursor_clear() {
		//Reset the flag 
		requestSubmitted = false;

		//Hide the progress bar dialog
		var dialog = dijit.byId('ext_progress_bar_dialog');
		var progressBar = document.getElementById('ext_progress_bar');
		if(dialog != null){
			if(progressBar != null){
				progressBar.style.display = 'none';
			}
			dialog.hide();
			this.currentId="";
		}
}	
/** End: Extended Progress bar: Need to remove after implementing checkout progress bar**/



SinglePageCheckoutJS = {
		
		// This variable stores the ID of the language that the store is currently using.                
		langId: "-5",
             
        // This variable stores the ID of the current store.       
		storeId: "",
              
        // This variable stores the ID of the catalog that is used in the store.                 
		catalogId: "",   
		
		// This variable stores the ID of the order that is used in the checkout
        orderId: "",
        
        // This variable indicates whether the Ajax CheckoutOut flex flow is enabled or not.                   
		ajaxCheckOut: true,
		
		// This variable to save to the type of warranty to process the warranty item.                   
		warrantyType: "",
		
		// This variable to save to the years of warranty to process the warranty item.                   
		warrantyYears: "",
		
		// This variable to save to the warranty itemId to process the warranty item.                   
		catEntryIdTo: "",
		
		// This variable to indicate whether redirect to shop cart page after delete last item                   
		redirectToShopcart: false,
		
		// This variable to indicate selected deleivery option by the user  
		selectedDeliveryOption: "",
		
		// This string will save the valid click and collect orderitems which will sent to command while select physical store
		validCCOrderItems: "",
		
		// This variable to save the selected novios code from the search results
		noviosCode: "",
		
		// This varaible to save selected novios first and last name from the search results
		noviosNames: "",
		
		// This variable to save the domain name to be used for cookie 
		cookieDomainName: "",
		
		// This variable to indicate whether all the items are deleted or not
		deleteAllItems: false,
		
		// To store the total number of orderitems in the order
		totalOrderItems: "",
		
		// Calendar Modal varaiables
		calendarContainer : "",
		noShowCalendarModal : false,
		deleteSelectedMarker : true,
						
		// Set the common id's used in the single checkout page
		setCommonParameters:function(langId,storeId,catalogId,orderId){
			this.langId = langId;
			this.storeId = storeId;
			this.catalogId = catalogId;
			this.orderId = orderId;
		},
		
		// Updates the specified context's property and assign it the desired value.
		setContextProperty:function(contextId,property,value){
			wc.render.getContextById(contextId).properties[property] = value;
		},
		
		// Sets the URL of the specified controller.
		setControllerURL:function(controllerId,url){
            wc.render.getRefreshControllerById(controllerId).url = url;
		},
		
		// Guest Logon Form Validation and Submit
		submitGuestCheckoutLogon:function(form){
			specialCharactersRegexPwd = new RegExp(/^[A-Za-z0-9_!?,.()-@$#&\/%]/);
			reWhiteSpace = new RegExp(/^\s+$/);
			isValid = true;						
			
			if(form.logonId != null && reWhiteSpace.test(form.logonId.value) || form.logonId.value == ""){ 
				displayErrorMessage("logon_errormsg",MessageHelper.messages["ERROR_LogonIdEmpty"]); return;
			}
			if(!validateRut(form.logonId.value)){ 
				displayErrorMessage("logon_errormsg",MessageHelper.messages["ERROR_INVALID_RUT"]); return;
			}
			if(form.logonPassword != null && form.logonPassword.value == ""){ 
				displayErrorMessage("logon_errormsg",MessageHelper.messages["ERROR_PasswordEmpty"]); return;
			}
			isValid = validateAccentedCharacters(form.logonPassword.value,specialCharactersRegexPwd);
			
			if(form.logonPassword != null && !isValid){ 
				displayErrorMessage("logon_errormsg",MessageHelper.messages["ERROR_INVALID_CLAVE"]); return;}
			
			form.logonId.value = formatRut(form.logonId.value);
			/* For Handling multiple clicks.*/
			if(!submitRequest()){
				return;
			}
			
			form.submit();
		},
		
		// Proceed with guest checkout form
		continueAsGuest: function(){			
			if(null == this.orderId || "" == this.orderId || undefined == this.orderId)
				return false;
			// Refresh:- Step1 - User information form (Billing Address) 
			wc.render.updateContext("userDetailsAreaContext",{"orderId":this.orderId});
            AnchorScroll('#checkout_userdetails');

		},
		
		// Save Address of Guest and Register user
		saveAddress: function(formName,serviceId){
			var form = document.forms[formName];
			var valid =  validateAddressForm(form);
			
			if(valid){
				
				// To avoid duplicate request
				if(!submitRequest()){
					return;
				}
				
				var shipAddressHandler = dojo.subscribe("CustomShipAddressHandler",function(){
					// Open Progress bar
					openProgressBar();
					if(mapcityEnabled){
						CheckoutAddressHelper.searchAddress(true,null,CheckoutAddressHelper.findMatchOfSelectedComuna(CheckoutAddressHelper.getValueSelectedComuna()),CheckoutAddressHelper.findElementsForMapCity('address1').value,CheckoutAddressHelper.findElementsForMapCity('address2').value, true);
					}else{
						CheckoutAddressHelper.setAddressMapAttrs('0', '0', flagMapCity);
						dojo.publish('CustomSaveAddressHandler');
					}
																		
					//dojo.unsubscribe(shipAddressHandler);
				});
				
				var saveAddressHandler = dojo.subscribe("CustomSaveAddressHandler",function(){
					var addressService = wc.service.getServiceById(serviceId);
				 	addressService.formId = formName;
				 	   	 					 						
					wc.service.invoke(serviceId);
					// Unsubscribe the handlers
					dojo.unsubscribe(saveAddressHandler);
					dojo.unsubscribe(shipAddressHandler);
				});
				
				if(formName == 'ShipAddressForm'){
					// Shipping Address
					dojo.publish('CustomShipAddressHandler');
				}else{
					// Billing Address
					openProgressBar();
					dojo.publish('CustomSaveAddressHandler');
				}
				
			} else {
				return isValid;
			}

		},
				
		// Check if shipping information has changed from default		 
		checkShippingInstructionUpdate: function(formName){
			var form = document.forms[formName];
			if(document.getElementById('default_shipping_instruction')){
				if(form['address3'].value == document.getElementById('default_shipping_instruction').value){ 
					form['address3'].value = '';
				}
			}
		},
		
		/**
		 * Method with generate the Comuna objects based on the JSON in AddresHelperComunaSelection.jspf
		 */
		getCommunesArray:function(){
			//If the regions array does not already exist then create it.
			if (document["regions"] == null){
				regions = new Array();
				var theDiv = document.getElementById("communesListSelectionHelper");
				
				if (typeof theDiv == 'undefined'){
					return null;
				}
				var divJSON = eval('('+ theDiv.innerHTML +')');
				var regionsObject = divJSON.regions;
						
				for (var i = 0; i < regionsObject.length; i++)
				{
					var regionObject = regionsObject[i];
					regions[regionObject.displayName] = new Object();
					regions[regionObject.displayName].name = regionObject.displayName;
					regions[regionObject.displayName].numCode = regionObject.numCode;
							
					if (regionObject.comunas.length > 0)
					{
						regions[regionObject.displayName].comunas = new Object();
						for (var j = 0; j < regionObject.comunas.length; j++)
						{
							var communa = regionObject.comunas[j];		
							regions[regionObject.displayName].comunas[communa.displayName] = new Object();
							regions[regionObject.displayName].comunas[communa.displayName].name = communa.displayName;
							if(typeof communa.mapCityComuna != 'undefined'){
								regions[regionObject.displayName].comunas[communa.displayName].mapCityComuna = communa.mapCityComuna;							
							}else{
								regions[regionObject.displayName].comunas[communa.displayName].mapCityComuna = null;
							}
							
							if(typeof communa.mapCityXcom != 'undefined')
								regions[regionObject.displayName].comunas[communa.displayName].mapCityXcom = communa.mapCityXcom;
							else
								regions[regionObject.displayName].comunas[communa.displayName].mapCityXcom = null;
							
							if(typeof communa.mapCityYcom != 'undefined')
								regions[regionObject.displayName].comunas[communa.displayName].mapCityYcom = communa.mapCityYcom;
							else
								regions[regionObject.displayName].comunas[communa.displayName].mapCityYcom = null;
			
						}
					}
				}
			}
			return regions;	 
		},
		/**
		 * Generate options for Comuna drop down based on Regions selected.
		 */
		loadCommunes:function(formName, comunaNode){
			// Initialize communa array
			this.getCommunesArray();
			var form = document.getElementById(formName);					
			var currentRegionCode = form["state"].value;
			var comunaNodeObj = document.getElementById(comunaNode);
			var currentComuna = "";
			if(form["city"].value != 'Selecciona una comuna'){
				currentComuna = form["city"].value;
			}			

			if ((regions[currentRegionCode] != null) && (regions[currentRegionCode] != 'undefined') && (regions[currentRegionCode] != '')) {				
				this.createCommunaWithOptions(currentRegionCode, currentComuna, comunaNodeObj);
			}
			
		},		
		
		/**
		 * Create options for Comuna Drop Down
		 */
		createCommunaWithOptions:function(currentRegionCode, currentComuna, comunaNode){						
			/*clear old options. */
			comunaNode.options.length = 0;
			var comuneRemove = "Corral";						
			var defaultOption = document.createElement("option");
			comunaNode.options[0] = defaultOption;
			defaultOption.text = "Selecciona una comuna";
			defaultOption.value = "Selecciona una comuna";
					
			/* add all states. */
			for (commune_code in regions[currentRegionCode].comunas) {			
				if ("" != commune_code && commune_code != comuneRemove) {
					aOption = document.createElement("option");
					comunaNode.options[comunaNode.length] = aOption;			
					aOption.text = regions[currentRegionCode].comunas[commune_code].name;
					aOption.value = commune_code;			
					if (commune_code == currentComuna || regions[currentRegionCode].comunas[commune_code].name == currentComuna) {
						aOption.selected = true;
					}
				}
			}
			// Mapcity
//			if(comunaNode.id && comunaNode.id == 'checkout_shipping_city'){
//				comunaNode.setAttribute("onChange","javascript:CheckoutAddressHelper.comunaSelectOnChange(this);");
//			}
			//return comunaNode;
		},
		
		/**
		 * This function is used to update the address of all order items in a single shipment checkout-out scenario.
		 * When updating addressId to order items below service call will be executed
		 * 1. AjaxOrderChangeServiceGiftInfoUpdate - Parallel
		 * 2. AjaxOrderChangeServiceShipInfoUpdate - Parallel
		 * 3. AjaxOrderProcessServiceOrderPrepare  - Sequential
		 * 4. AjaxOrderCalculate				   - Sequential 
		 * 5. Refresh the orderItems details Area. - Sequential
		 *
		 * @param {int} addressId The address ID of the address that will be applied to all items.
		 */
		updateAddressIdForAllItems:function(addressId,externalId){
						
			if(addressId == -1) 
				return;
			params = [];
			params["storeId"] = this.storeId;
			params["catalogId"] = this.catalogId;
			params["langId"] = this.langId;
			params.orderId = ".";
			params.calculationUsage = "-1,-2,-3,-4,-5,-6,-7";
			params.allocate="***";
			params.backorder="***";
			params.remerge="***";
			params.check="*n";
			// Parameter to call EOM integration
			params["EOM"] = "true";
			params["addressId"] = addressId;

			// If user click on the div instead of radio button from the address list in DaD, make the radio button as checked.
			if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabDespacho' && addressId &&
					dojo.byId('select_ship_address_'+addressId)){
				dojo.byId('select_ship_address_'+addressId).checked = true;
			}
			
			/**
			 * Applicable only for Novios flow
			 * so addressId will be -3
			 */
			if(externalId && externalId != "") {
				params.externalId = externalId;
			}
			
			// MHTN:CLICK AND COLLECT
			if(SinglePageCheckoutJS.selectedDeliveryOption == "TabRetiroEnTienda"){
				SinglePageCheckoutJS.validCCOrderItems = dojo.byId('validCCOrderItems').value;
				params.validCCOrderItems = SinglePageCheckoutJS.validCCOrderItems;
			}
			// MHTN:CLICK AND COLLECT
			
			// MHTN:CHILE EXPRESS
			if(SinglePageCheckoutJS.selectedDeliveryOption == "TabChileExpress"){
				SinglePageCheckoutJS.validCEOrderItems = dojo.byId('validCEOrderItems').value;
				params.validCEOrderItems = SinglePageCheckoutJS.validCEOrderItems;
			}
			// MHTN:CLICK AND COLLECT
						
//			if (typeof updateGiftRegistrantAddressForItemsExt != "undefined" && typeof updateGiftRegistrantAddressForItemsExt!=null) {
				 
			// Service call to AjaxOrderChangeServiceGiftInfoUpdate
			params = updateGiftRegistrantAddressForItemsExt(params,addressId);
//			} 
			
			
			//For handling multiple clicks
			if(!submitRequest()){
				return;
			}              
			
			if(dojo.byId('progress_bar') && dojo.byId('progress_bar').style.display == "none"){        	       
				setTimeout('openProgressBar()',10);
		    } 
			
						
//			if(document.getElementById('nextPageLower')){
//				dojo.addClass(document.getElementById('nextPageLower'), 'button_inactive');
//			}
			// Service call to AjaxOrderChangeServiceShipInfoUpdate
			wc.service.invoke("OrderItemAddressShipMethodUpdate", params);               		
			                                            
		},
		
		/**
		 * Function to delete the wartanty item from the cart.
		 */
		deleteWarrantyFromCart:function(orderItemId) {
						
			var params = [];
			params.storeId = this.storeId;
			params.catalogId = this.catalogId;
			params.langId = this.langId;
			params.orderId = (this.orderId != null && this.orderId != 'undefined' && this.orderId != "")?this.orderId:".";
			params.calculationUsage = "-1,-2,-3,-4,-5,-6,-7";
			params.orderItemId = orderItemId;
			  
			//For handling multiple clicks
			if(!submitRequest()){
				return;
			} 			
			//cursor_wait();			
			openProgressBar();
			wc.service.invoke("AjaxDeleteOrderItem", params);
		},	
		
		/**
		 * Function to update the warranty item to the cart.
		 */
		changeWarrantyItemInCart:function(orderItemId, catEntryIdTo, warrantyYears, warrantyType){ 			
			
			var params = [];
			params.storeId = this.storeId;
			params.catalogId = this.catalogId;
			params.langId = this.langId;
			params.orderId = (this.orderId != null && this.orderId != 'undefined' && this.orderId != "")?this.orderId:".";
			params.orderItemId = orderItemId;
			params.calculationUsage = "-1,-2,-3,-4,-5,-6,-7";
						
			
			if(null != warrantyType) {
				this.warrantyType = warrantyType;
			}
			if(null != warrantyYears) {
				this.warrantyYears = warrantyYears;
			}
			
			this.catEntryIdTo = catEntryIdTo;
			//For handling multiple clicks
			if(!submitRequest()){
				return;
			}   
			//cursor_wait();
			openProgressBar();
			
			wc.service.invoke("AjaxChangeWarrantyItemInCart", params);
		},
		
		/**
		 * Function to add item to cart.(This will be used for adding warranty item in checkout page)
		 */
		AddItem2ShopCartAjax : function(catEntryIdentifier, quantity, customParams)
		{
			var params = [];
			params.storeId		= this.storeId;
			params.catalogId	= this.catalogId;
			params.langId		= this.langId;
			params.orderId		= ".";
			params.productId	= catEntryIdentifier;
			params.calculationUsage = "-1,-2,-3,-4,-5,-6,-7";
			var ajaxShopCartService = "AjaxWarrantyItemAddService";			
			
			if(dojo.isArray(catEntryIdentifier) && dojo.isArray(quantity)){
				for(var i=0; i<catEntryIdentifier.length; i++){
					if(!isPositiveInteger(quantity[i])){
						MessageHelper.displayErrorMessage(MessageHelper.messages['QUANTITY_INPUT_ERROR']);
						return;
					}
					params["catEntryId_" + (i+1)] = catEntryIdentifier[i];
					params["quantity_" + (i+1)]	= quantity[i];
				}
			}
			else{
				if(!isPositiveInteger(quantity)){
					MessageHelper.displayErrorMessage(MessageHelper.messages['QUANTITY_INPUT_ERROR']);
					return;
				}
				params.catEntryId	= catEntryIdentifier;
				params.quantity		= quantity;
			}		

			//Pass any other customParams set by other add on features
			if(customParams != null && customParams != 'undefined'){
				for(i in customParams){
					params[i] = customParams[i];
				}								
			}
			// Add shipping address to warranty item
			if(dojo.byId('selectedShipAddressId') && dojo.byId('selectedShipAddressId').value != ""){
				params.addressId =  dojo.byId('selectedShipAddressId').value;
			}
			
			//For Handling multiple clicks
			if(!submitRequest()){
				return;
			}   
			//cursor_wait();	
			openProgressBar();
			
			wc.service.invoke(ajaxShopCartService, params);

		},
		
		/**
		 * This function deletes an order item from the  cart.		 		 
		 * @param {Integer} orderItemId The ID of the order item to delete.
		 * @param {Boolean} forWishlist If the value is true, then the item is added to the wish list.
		 */
		deleteFromCart:function(orderItemId){ 
			
			var params = [];
			params.storeId = this.storeId;
			params.catalogId = this.catalogId;
			params.langId = this.langId;
			params.orderId = (this.orderId != null && this.orderId != 'undefined' && this.orderId != "")?this.orderId:".";
			params.calculationUsage = "-1,-2,-3,-4,-5,-6,-7";
			
			var isItemWithWarranty = false;
			
			var y = x = 0;
			if(document.getElementById("totalNumberOfItems")) {
				var y = x = document.getElementById("totalNumberOfItems").value
			}

			//Now remove free items from this total number of items count.. 
			//x = total items and y = totalItems - totalFreeItems
			for(var i = 0; i < x; i++){
				var qtyObj = document.getElementById("freeGift_qty_"+(i+1));
				if (qtyObj!=null || qtyObj != undefined) {
					qty = qtyObj.value;
					if(qty!=null && qty!=undefined && qty == -1){
						y = y - 1;
					}
				}
			}
			
			// check for related warranty item
			if(document.getElementById("warranty_check_for_" + orderItemId)){
				var warrantyItem = document.getElementById("warranty_check_for_" + orderItemId);
				if(warrantyItem.checked) {
					isItemWithWarranty = true;
					params.orderItemId_0 = orderItemId;
					params.orderItemId_1 = warrantyItem.value; //warranty item orderId
				} else {
					params.orderItemId = orderItemId;
				}
			} else {
				params.orderItemId = orderItemId;
			}
			  
			//For handling multiple clicks
			if(!submitRequest()){
				return;
			} 
			//cursor_wait();
			
			// This is the last item, so after removing it, redirect the user to shop cart page
			if(y == 1 || (y == 2 && isItemWithWarranty)){
				this.redirectToShopcart = true; 				
			}
			
			// To open the progress bar
			openProgressBar();
			
			wc.service.invoke("AjaxDeleteOrderItem", params);
		},
		
		// This will be triggered on sucesss of AjaxProxyPickup update call
		processCheckoutShippingDetails: function(){
			//Call service to PrepareOrder and then show the billingPage....
			var params = [];
			
			// Code to save gift details information entered by user in novios flow
			// This applicable only to "only novios" order - All orderitems shipmode - 18 
			var giftPurchase = document.getElementById("send_greeting");
			if (giftPurchase)
			{
				var giftData;							
				giftData = "N";
				
				giftData = giftData + "|" + document.getElementById("gift_greeting_text").value;
				giftData = giftData + "|" + "";
				params["giftData"] = giftData;
			}

			params["storeId"] = this.storeId;
			params["catalogId"] = this.catalogId;
			params["langId"] = this.langId;
			params.orderId		= ".";
			// Flag to indicate to call EOM integration before going to payment details
			params["OEM"] = "OEM";							
			
//			if(!submitRequest()){
//				return;
//			}   			
			//cursor_wait();
			if(this.selectedDeliveryOption != 'TabRetiroEnTienda' && dojo.byId('proxy_checkbox')){
				dojo.byId('proxy_checkbox').checked = false;
			}
			
			wc.service.invoke('AjaxPrepareOrderBeforePaymentCapture',params);
			return;
		},
		// Funtion to load the physical stores based on the selected zona
		loadPhysicalStores: function(currentZona){
			//If the zonaStores array does not exist already then create it.
			if (document["zonaStores"] == null){							
				var zonaDiv = dojo.byId('zonastore');
				var zonaJson = eval('('+zonaDiv.innerHTML+')');
				
				// Create new array with zona and asscoiated stores
				zonaStores = new Array(); 
				
				var zonasObject= zonaJson.zonaStores; 
				
				for(var i=0;i<zonasObject.length;i++)
				{ 
					var zonaObject = zonasObject[i];
					zonaStores[zonaObject.zona] = new Object();
					zonaStores[zonaObject.zona].name = zonaObject.zona; 
					if(zonaObject.stores.length > 0){
						zonaStores[zonaObject.zona].stores = new Object();
						for(var j=0;j<zonaObject.stores.length; j++){
							var stores = zonaObject.stores[j];
							zonaStores[zonaObject.zona].stores[stores.store] = new Object();
							zonaStores[zonaObject.zona].stores[stores.store].name = stores.store;
							zonaStores[zonaObject.zona].stores[stores.store].addressId = stores.addressId;
							zonaStores[zonaObject.zona].stores[stores.store].address = stores.address;
						}
					}
				}
			}
			// Clear the existing options and create new options according to current zona.
			var storeSelectDiv = dojo.byId('list_tienda');
			// Clear old options of select 
			storeSelectDiv.options.length = 0;
			
			var defaultOption = document.createElement("option");
			storeSelectDiv.options[0] = defaultOption;
			defaultOption.text = "Seleccionar Tienda";
			defaultOption.value = "Seleccionar Tienda";
			
			if(zonaStores[currentZona] != null && zonaStores[currentZona] != 'undefined' && zonaStores[currentZona] != ''){
				for(store in zonaStores[currentZona].stores){
					aOption = document.createElement("option");
					storeSelectDiv.options[storeSelectDiv.length] = aOption;				
					aOption.text = zonaStores[currentZona].stores[store].name;
					aOption.value = zonaStores[currentZona].stores[store].addressId;
				}
			}else{
				dojo.byId('checkout_ret_continue').className = "button disabled";
			}			
		},
		
		// 1148 Funtion to load the physical Offices based on the selected region
		loadPhysicalOffices: function(currentRegion){
			//If the zonaStores array does not exist already then create it.
			if (document["officeStores"] == null){							
				var officeDiv = dojo.byId('officestore');
				var officeJson = eval('('+officeDiv.innerHTML+')');
				
				// Create new array with zona and asscoiated stores
				officeStores = new Array(); 
				
				var officesObject= officeJson.officeStores; 
				
				for(var i=0;i<officesObject.length;i++)
				{ 
					var officeObject = officesObject[i];
					officeStores[officeObject.office] = new Object();
					officeStores[officeObject.office].name = officeObject.office; 
					if(officeObject.cestores.length > 0){
						officeStores[officeObject.office].cestores = new Object();
						for(var j=0;j<officeObject.cestores.length; j++){
							var cestores = officeObject.cestores[j];
							officeStores[officeObject.office].cestores[cestores.cenickname] = new Object();
							officeStores[officeObject.office].cestores[cestores.cenickname].name = cestores.cenickname;
							officeStores[officeObject.office].cestores[cestores.cenickname].addressId = cestores.addressId;
							officeStores[officeObject.office].cestores[cestores.cenickname].address = cestores.address;
							officeStores[officeObject.office].cestores[cestores.cenickname].nickName = cestores.cenickname;
						}
					}
				}
			}
			// Clear the existing options and create new options according to current zona.
			var cestoreSelectDiv = dojo.byId('list_office');
			// Clear old options of select 
			cestoreSelectDiv.options.length = 0;
			
			var cedefaultOption = document.createElement("option");
			cestoreSelectDiv.options[0] = cedefaultOption;
			cedefaultOption.text = "Seleccionar Office";
			cedefaultOption.value = "Seleccionar Office";
			
			if(officeStores[currentRegion] != null && officeStores[currentRegion] != 'undefined' && officeStores[currentRegion] != ''){
				for(cestore in officeStores[currentRegion].cestores){
					aOption = document.createElement("option");
					cestoreSelectDiv.options[cestoreSelectDiv.length] = aOption;				
					aOption.text = officeStores[currentRegion].cestores[cestore].nickName;
					aOption.value = officeStores[currentRegion].cestores[cestore].addressId;
				}
			}else{
				dojo.byId('checkout_chileExp_continue').className = "button disabled";
			}			
		},
		
		// Function to select physical store address
		selectPhysicalStoreAddress: function(value){
			var storeSubmitDiv = dojo.byId('checkout_ret_continue');
			var storeSubmitDiv1 = dojo.byId('checkout_chileExp_continue');
			if(value == "Seleccionar Tienda"){
				storeSubmitDiv.className = "button disabled";
				storeSubmitDiv1.className = "button disabled";
			}else{
				storeSubmitDiv.className = "button";
				storeSubmitDiv1.className = "button";
			}
		},
		// Function to select physical store address
		selectChileExpressAddress: function(value){
			var storeSubmitDiv1 = dojo.byId('checkout_chileExp_continue');
			if(value == "Seleccionar Tienda"){
				storeSubmitDiv1.className = "button disabled";
			}else{
				storeSubmitDiv1.className = "button";
			}
		},
		
		// Function to save selected physical store address to orderItems
		savePhysicalStoreAddress: function(){
			var storeSelectDiv = dojo.byId('checkout_ret_continue');
			var storeSelect = dojo.byId('list_tienda');
			if(storeSelectDiv.className == "button" && storeSelect.value != "Seleccionar Tienda"){				
				var storeAddressId = storeSelect.value;
				// Refresh Step2: Enable the selected address and enable the order item details
				var selectedZona = dojo.byId('list_zonaname').value;
				
				var selectPhysicalStoreAddressHandler = dojo.subscribe("CustomSelectPhyscialStore",function(){
					// Open Progress bar
					setTimeout('openProgressBar()',10);
					wc.render.updateContext("selectedPhysicalStoreAreaContext",{"orderId":SinglePageCheckoutJS.orderId,"zona":selectedZona,"addressId":storeAddressId});									
					dojo.unsubscribe(selectPhysicalStoreAddressHandler);
				});
				// If any non CC item in the order first user has to delete before proceeding
				if(dojo.query('.invalidCCOrderItem').length > 0){
					SinglePageCheckoutJS.openPickupModal();
				}else{
					dojo.publish('CustomSelectPhyscialStore');
				}
				
			} else {
				return false;
			}
		},
		// Function to save selected physical store address to orderItems
		saveChileExpressAddress: function(){
			var cestoreSelectDiv1 = dojo.byId('checkout_chileExp_continue');
			var cestoreSelect = dojo.byId('list_office');
			if(cestoreSelectDiv1.className == "button" && cestoreSelect.value != "Seleccionar Office"){				
				var cestoreAddressId = cestoreSelect.value;
				// Refresh Step2: Enable the selected address and enable the order item details
				var selectedRegion = dojo.byId('list_regionname').value;
				
				var selectPhysicalStoreAddressHandler = dojo.subscribe("CustomSelectPhyscialStore",function(){
					// Open Progress bar
					setTimeout('openProgressBar()',10);
					wc.render.updateContext("selectedPhysicalCEStoreAreaContext",{"orderId":SinglePageCheckoutJS.orderId,"region":selectedRegion,"addressId":cestoreAddressId});									
					dojo.unsubscribe(selectPhysicalStoreAddressHandler);
				});
				// If any non CC item in the order first user has to delete before proceeding
				if(dojo.query('.invalidCEOrderItem').length > 0){
					SinglePageCheckoutJS.openPickupModal();
				}else{
					dojo.publish('CustomSelectPhyscialStore');
				}
				
			} else {
				return false;
			}
		},
		
		// Function to show / hide the proxy pickup options
		showorhideProxyPopup:function(){
	    	var checkbox=document.getElementById('proxy_checkbox');
	    	if(checkbox.checked){
	    		document.getElementById('proxypickup_content').className="show";	    			    		
	    	}else{
	    		document.getElementById('proxypickup_content').className="hide";	    			    		
	    	}
	    },
	    // Funtion to restrict user to not to enter numbers*/
	    isNumberEntered :function(e){
	    	var keyCode = (e.keyCode ? e.keyCode : e.which);
	    	if ((keyCode > 47 && keyCode < 58) || (keyCode > 95 && keyCode < 106)) {
	            e.preventDefault();
	        }
	    },
	    /*To update proxy pickup details*/
	    updateProxyPickupDetails:function(){
	    	var params = [];
	    	
	    	var proxypickupenable=false;
	    	if(document.getElementById('proxy_checkbox')){
	    		proxypickupenable = document.getElementById('proxy_checkbox').checked;
	    	}
	    	params.isPickUpProxyEnabled=proxypickupenable;
	    	params.orderId=this.orderId;
	    	if(document.getElementById("proxyPickUpAddressId")){
	    		params.addressId=document.getElementById("proxyPickUpAddressId").value;
	    	}else{
	    		params.addressId="";
	    	}
	    	if(proxypickupenable){
	    		var firstName=document.getElementById('proxy_firstName').value;
	    		var lastName=document.getElementById('proxy_lastName').value;
	    		params.firstName=firstName;
	    		params.lastName=lastName;
	    	}
	    	// To avoid duplicate request
			if(!submitRequest()){
				return;
			} 
			openProgressBar();
			wc.service.invoke("AjaxCENUpdatePickUpProxyDetails", params);
	    },
	    
	    /*Validate proxy pickup details*/
	    validatePickUpAndGreetingParams:function(){
	    	/**
	    	 * First check the style of submit button, if it is disabled return the control
	    	 */
	    	if(dojo.byId('goto_step3').className == 'button disabled'){
	    		return false;
	    	}
	    	
	    	// Validate the address3/comments field if novios shipping is selected
	    	if(SinglePageCheckoutJS.selectedDeliveryOption == "TabNovio"){
	    		if(document.getElementById("gift_greeting_text")!= null){
	    			specialCharactersRegex4 = new RegExp(/^[A-Za-z0-9_?!?,.()@$#?\s&\/%-]/);
                    isValid = validateAccentedCharacters(document.getElementById("gift_greeting_text").value,specialCharactersRegex4);
                    if(!isValid){
                    	MessageHelper.displayErrorMessage(MessageHelper.messages["ERROR_FACILITAR_TU_DESPACHO"]);
                    	return false; 
                    }
	    		}
	    	}
	    	
	    	var proxypickupenable=false;
	    	if(document.getElementById('proxy_checkbox')){
	    		proxypickupenable = document.getElementById('proxy_checkbox').checked;
	    	}
	    	if(proxypickupenable){
	    		var firstName=document.getElementById('proxy_firstName').value;
	    		var lastName=document.getElementById('proxy_lastName').value;

	    		reWhiteSpace = new RegExp(/^\s+$/);
				if(firstName == "" || reWhiteSpace.test(firstName) || firstName.length < 2 ){ 
					MessageHelper.displayErrorMessage(MessageHelper.messages['ERR_PICKUP_DETAILS']);	
					dojo.byId('proxy_firstName').focus();
					return false;
				}
				if(lastName == "" || reWhiteSpace.test(lastName) || lastName.length < 2){					
					MessageHelper.displayErrorMessage(MessageHelper.messages['ERR_PICKUP_DETAILS']);					
					dojo.byId('proxy_lastName').focus();
					return false;
				}
				allowedCharRegExp = new RegExp(/^[A-Za-z\s.,-\/]/);
				if(!validateAccentedCharacters(firstName,allowedCharRegExp)){ 
					MessageHelper.displayErrorMessage("proxy_firstName",MessageHelper.messages["ERROR_FACILITAR_TU_DESPACHO"]); 
					return false;
				}
				if(!validateAccentedCharacters(lastName,allowedCharRegExp)){ 
					MessageHelper.displayErrorMessage("proxy_lastName",MessageHelper.messages["ERROR_FACILITAR_TU_DESPACHO"]); 
					return false;
				}
				
	    	}
	    	return true;
	    },
	    // Function to hide / show physical store and order item details
	    changePhysicalStore: function(){
	    	// Hide order item details area
	    	if(dojo.byId('checkout_orderitem_groups')){
	    		dojo.byId('checkout_orderitem_groups').className = "hide";
	    	}
	    	// Hide ReT Details area
	    	dojo.byId('checkoutReTDetails').className = "hide";
	    	// Display the zona and store drop down
	    	dojo.byId('checkoutReTForm').className = "show";
            AnchorScroll("#ret_address_details");
            SinglePageCheckoutJS.selectedDeliveryOption="";
	    },
	    
	    changePhysicalOffice: function(){
	    	// Hide order item details area
	    	if(dojo.byId('checkout_orderitem_groups')){
	    		dojo.byId('checkout_orderitem_groups').className = "hide";
	    	}
	    	if(dojo.byId('checkoutCEDetails')){
	    		dojo.byId('checkoutCEDetails').className = "hide";
	    	}
	    	// Hide ReT Details area
	    	dojo.byId('checkout_ce_address').className = "hide";
	    	// Display the zona and store drop down
	    	dojo.byId('checkoutCEForm').className = "show";
            AnchorScroll("#ce_address_details");
            SinglePageCheckoutJS.selectedDeliveryOption="";
	    },
	    
	    // Function to call Novios search refresh area
	    updateNoviosAddressModalSearch: function(form, isBillingPageValue) {
	    		    	    	 
	    	//Minimum - 3 characters needs to enter to search.	    	 
	    	var firstNameValue = trim(form["noviosFirstName"].value);
	    	var lastNameValue = trim(form["noviosLastName"].value);
	    	var externalIdValue = trim(form["externalId"].value);
	    	
	    	// Hide the search result area while form submit and clear the error message
	    	displayNoviosSearchResultArea('submit');
	    	dojo.byId('novios_search_message').innerHTML = "";
	    	
	    	var invalidFieldLength = false;
	    	
	    	if(firstNameValue == "" && lastNameValue == "" && externalIdValue == ""){
	    		displayNoviosSearchResultArea('error');
	    		dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["CHECKOUT_STEP2_NOVIOS_NO_RESULTS"];
	    		return;
	    	}else if((firstNameValue != "" && firstNameValue.length < 3) && lastNameValue == "" && externalIdValue == ""){
	    		invalidFieldLength = true;	    		
	    	}else if((lastNameValue != "" && lastNameValue.length < 3) && firstNameValue == "" && externalIdValue == ""){
	    		invalidFieldLength = true;	    		
	    	}else if((externalIdValue != "" && externalIdValue.length < 3) && firstNameValue == "" && lastNameValue == ""){
	    		invalidFieldLength = true;	    		
	    	}else if((externalIdValue != "" && externalIdValue.length < 3) || (lastNameValue != "" && lastNameValue.length < 3) 
	    			|| (firstNameValue != "" && firstNameValue.length < 3)){
	    		invalidFieldLength = true;	    			    				
	    	}	    	
	    	
	    	// Display the meesage to user
	    	if(invalidFieldLength){
	    		displayNoviosSearchResultArea('error');
	    		dojo.byId('novios_search_message').innerHTML = MessageHelper.messages["ERROR_INVALID_NOVIOS_FIELD_LENGTH"];
	    		return;
	    	}
	    	
	    	if((externalIdValue != "") && (externalIdValue != undefined) && (externalIdValue != null)){
	    		if((externalIdValue).length<8){
	    			for(var i=(externalIdValue).length;i<8;i++){
	    				externalIdValue='0'+externalIdValue;
	    			}
	    		}
	    	}
	    	
	    	/*
	    	 * Passing date to validate the event date for below scenarios.
	    	 * 1) If event date is Inactive(eventdate > currentDate + 90 days).variable passing to NoviosAddressModelForm.jsp is "inactiveDate"
	    	 * 2) If event date is Expired(eventdate < currentDate - 7 days). variable passing to NoviosAddressModelForm.jsp is "newDate".
	    	 */
    		var tempDate = new Date();
    	    tempDate.setDate(tempDate.getDate() - 7);
    	    var year = tempDate.getFullYear();
    	    var month = (tempDate.getMonth()+1);
    	    var day = tempDate.getDate();
    	    if (parseInt(month) < 10) month = "0" + month;
    	    if (parseInt(day) < 10) day = "0" + day;
    	    var parsedDate = year + "-"+month +"-"+ day;
    	    var newDate = parsedDate;
    	    
    	    var tempDate1 = new Date();
    	    tempDate1.setDate(tempDate1.getDate() + 90);
    	    var year = tempDate1.getFullYear();
    	    var month = (tempDate1.getMonth()+1);
    	    var day = tempDate1.getDate();
    	    if (parseInt(month) < 10) month = "0" + month;
    	    if (parseInt(day) < 10) day = "0" + day;
    	    var parseDate = year + "-"+month +"-"+ day;
    	    var inactiveDate = parseDate;
    	    
    	    var currentDate = new Date();
    	    var year = currentDate.getFullYear();
    	    var month = (currentDate.getMonth()+1);
    	    var day = currentDate.getDate();
    	    if (parseInt(month) < 10) month = "0" + month;
    	    if (parseInt(day) < 10) day = "0" + day;
    	    var parseDate = year + "-"+month +"-"+ day;
    	    var presentDate = parseDate;
    	    
    	    if(!submitRequest()){
    	    	return;
    	    }
    		ext_cursor_wait();
    		wc.render.updateContext("noviosSearchResultsAreaContext", {firstName:firstNameValue, lastName:lastNameValue, externalId:externalIdValue, isBillingPage:isBillingPageValue, newDate:newDate, inactiveDate:inactiveDate, presentDate:presentDate});	    		    	
	        
        },
	    
	    // Function to sumbit the novios code form from the novios search results
	    submitNoviosForm: function (formElement,clicked_Id,billingPage,event,externalId) {
	    	
	    	var params = [];
	    	params.billingPage=(billingPage!=null&&billingPage!='undefined')?billingPage:false;
	    	// Step 2 : Shipping Flow - Novios Despacho or Step 3 : submit from the search modal
	    	if(clicked_Id == "novioscode_submit") {
	    		
	    		params.codigo = externalId;
	    		/*
	    		 *  Below if condition, to pass novios points when the user selects novios address from pago page.
	    		 */
	    		if(billingPage != '' && billingPage == true) {
	    			formElement.forPointsNovios.value = "12345";
	    			params.forPointsNovios = formElement.forPointsNovios.value;
	    		}
	    		
	    		if((params.codigo!="") && (params.codigo != undefined)){
	    			if((params.codigo).length<8){
	    				for(var i=(params.codigo).length;i<8;i++){
	    					params.codigo='0'+params.codigo;
	    				}
	    			}
	    		}
	    		
	    		if(!billingPage){
	    			SinglePageCheckoutJS.noviosNames = dojo.byId('novios_names_'+externalId).innerHTML;
	    			SinglePageCheckoutJS.noviosCode = externalId;	    			
	    		}
	    		
	    		params.forRegistryFlag = formElement.forRegistryFlag.value;
	    		params.orderId = formElement.orderId.value;
	    			    		
	    		if(!submitRequest()){
	    			return;
	    		}
	    		
	    		if(!billingPage){
	    			setTimeout('openProgressBar()',10);
	    		}
	    		
	    		wc.service.invoke("AjaxNoviosSection", params);
	    		
	    	} 
	    	// Step 3: Associate Novios Points - Billing Section - When user entered novios code and sumbit
	    	else if(clicked_Id == "codigoModel" && (event.keyCode == 13 || event == '')) {
	    		params.codigo = formElement.codigo.value;
	    		if((formElement.codigo.value != null) && (trim(formElement.codigo.value)!=""))
	    		{
	    			params.codigo = formElement.codigo.value;
	    			formElement.forPointsNovios.value = "12345";
	    			params.forPointsNovios = formElement.forPointsNovios.value;	    				    			
	    			
	    			// Formatting the novios code to 8 digits
	    			if((params.codigo != "") && (params.codigo != undefined)){
	    				if((params.codigo).length<8){
	    					for(var i=(params.codigo).length;i<8;i++){
	    						params.codigo='0'+params.codigo;
	    					}
	    				}
	    			}
	    			
	    			params.forRegistryFlag = formElement.forRegistryFlag.value;
	    			params.orderId = formElement.orderId.value;
	    			
	    			// To avoid multiple click
	    			if(!submitRequest()){
	    				return;
	    			}
	    			//cursor_wait();
	    			wc.service.invoke("AjaxNoviosSection", params);
	    		}else{
	    			displayErrorMessage("novios_input_billing_error_message", MessageHelper.messages["ERROR_codigoModelEmpty"]);
	    			return;
	    		}
	    		
	    	}
	    	// Step 3: Delete Novios Points Association from billing section	    	
	    	else if(clicked_Id == "DeleteNoviosCode") {
	    		params.forRegistryFlag = formElement.forRegistryFlag.value;
	    		params.orderId = formElement.orderId.value;
	    		// To avoid multiple click
    			if(!submitRequest()){
    				return;
    			}
	    		//cursor_wait();
	    		wc.service.invoke("AjaxNoviosSection", params);
	    	}
	    	
	    },
	    changeNoviosCode: function(){
	    	// Hide order item details area
	    	SinglePageCheckoutJS.selectedDeliveryOption = "";	    	
	    	if(dojo.byId('checkout_orderitem_groups')){
	    		dojo.byId('checkout_orderitem_groups').className = "hide";
	    	}	    		
	    	// hide the selected novios area
			dojo.byId('checkout_novios_address_detail').className = "hide";
			// show the novios search results area
			dojo.byId('select_novios_address').className = "show";
            AnchorScroll("#novios_address_details");
			
	    },
	    /**
	     * This method to delete or add payment instructions before reaching to payment hub page
	     */
	    deleteoraddPaymentInstruction: function(piAmount, paymentHubId, fopId, paymentHubMethodName, fopName, useDiscountAmount){
			
			var payMethod = "CencosudPaymentHub";			
			
			if(useDiscountAmount){
				// In call back command this value expected as 1, so changing from true to 1.				
				useDiscountAmount = 1;
		    	payMethod = "TarjetaCencosud";
		    }else{
		    	useDiscountAmount = 0;
		    }
			if(dojo.byId('payMethod_'+fopId) && dojo.byId('payMethod_'+fopId).value==='CENCBSSimplePunchout'){
				payMethod = "CENCBSSimplePunchout";
			}
			// Handler to proceed with checkout flow to payment hub page.
			var processCustomCheckoutHandler = dojo.subscribe("CustomProcessCheckout", function(){
				if (document.getElementById("giftCardCookie")) {
					//  Need to change the path in the cookie 
					dojo.cookie("paymentHubDetails", document.getElementById("giftCardCookie").value, {path: '/', domain: SinglePageCheckoutJS.cookieDomainName});
					document.payment_form.submit();	
				}else {
						var payment_url = document.getElementById('payment_url').value;		
						var piID = dojo.byId('piId').value;
						
						var payment_cookie = paymentHubId + "|" + paymentHubMethodName + "|" + fopName + "|" + useDiscountAmount ;
						// Need to change the path in the cookie 
						dojo.cookie("paymentHubDetails", payment_cookie, {path: '/', domain: SinglePageCheckoutJS.cookieDomainName});
						
						payment_url = payment_url+"&fopId="+fopId;			
					console.debug("payment_url --> " + payment_url);
					
					var orderValidateURL = dojo.byId('OrderValidateBeforePaymentURL').value;
                                        orderValidateURL = orderValidateURL + "&payment_id="+ dojo.byId('payment_id').value +"&piId=" + piID + "&payment_url=" + payment_url+"&payMethod="+ payMethod; 
					// Redirect the user to payment hub page.
					document.location.href = orderValidateURL.replace(/&amp;/g, '&');
				}
			});
			
			// This is for only giftcard payment method 
			if (document.getElementById("giftCardCookie")) {				
				// This will call the addpayment instruction service
				dojo.publish("CustomProcessCheckout");			
			}else{		
				// This is for Mixed payment method or only payment hub method 
				var params = [];
				params["storeId"] = this.storeId;
				params["catalogId"] = this.catalogId;
				params["langId"] = this.langId;
				params.orderId = dojo.byId('piOrderId').value;
				params.authToken = dojo.byId('authToken').value;
				params["requesttype"] = "ajax";
			
				// Handler to call addpaymentinstruction service
				var addPaymentInstructionHandler = dojo.subscribe("CustomAddPaymentInstruction", function(){
					params.piAmount = piAmount;
					params.payMethodId = payMethod;
					params.payment_hub_id = paymentHubId;
					params.fopId = fopId;
					params.fopName = fopName;
					params.useDiscountAmount = useDiscountAmount;
					params.payment_hub_method = payMethod;
					
					// Update giftcard data to protocol data of payment instruction, which will be used by call back command to create GC payment instruction
					if(null != document.getElementById('giftCardNumber') && "" != document.getElementById('giftCardNumber').value ){
						params.gftCardNum = document.getElementById('giftCardNumber').value;
						if(null != document.getElementById('password') && "" != document.getElementById('password').value ){
							params.gftCardPswd = document.getElementById('password').value;
						}
						if(null != document.getElementById('giftCardPAmount') && "" != document.getElementById('giftCardPAmount').value ){
							params.gftCardAmt = document.getElementById('giftCardPAmount').value;
						}
						
					}					
					// To avoid Multiple click
					if(!submitRequest()){
						return;
					}
					if(dojo.byId('payMethod_'+fopId)){
						if(dojo.byId('payMethod_'+fopId).value==='CENCBSSimplePunchout'){
							params=SinglePageCheckoutJS.createCBSTokenizationRequest(params);
						}
					}
					//cursor_wait();	
					wc.service.invoke('AjaxAddPaymentInstructionToThisOrder',params);
					dojo.unsubscribe(addPaymentInstructionHandler);
				});								
				
				// If any payment instruction exist already, remove it first and then call add payment instruction
				if(null != dojo.byId('existingPids') && "" != dojo.byId('existingPids').value){
					params["piId"] = new Array();
					var existingPids = dojo.byId('existingPids').value;
					var pidArr = existingPids.split(",");
					for(var j=0; j < pidArr.length; j++){
						params["piId"].push(pidArr[j]);
					}										
					
					// To avoid multiple click
					if(!submitRequest()){
						return;
					}   			
					//cursor_wait();
					wc.service.invoke('AjaxDeletePaymentInstructionFromThisOrder',params);
					
				}else{						
					// This will call the addpayment instruction service
					dojo.publish("CustomAddPaymentInstruction");

				}
			}
		},
		// This function will be called non CC products exist for CC flow. 
		submitForDeleteItems : function (){
			var params = [];
			params.orderId = SinglePageCheckoutJS.orderId;
			params.langId = SinglePageCheckoutJS.langId
			params.storeId = SinglePageCheckoutJS.storeId
			params.catalogId = SinglePageCheckoutJS.catalogId
			var count = 1;
			dojo.query('.invalidCCOrderItem').forEach(function(element){
				params["orderItemId_" + count] = element.value;
				params["quantity_" + count] = 0;
				count = count + 1;
			});
			if(dojo.query('.invalidCCOrderItem').length == dojo.query('#noOfOrderItems')[0].value){
				SinglePageCheckoutJS.deleteAllItems = true;
			}
			// To avoid Multiple click
			if(!submitRequest()){
				return;
			}
			
			// Service call to delete the orderitems
			wc.service.invoke("MhtnOrderItemUpdateCC", params);
		},
		closePickupModal : function (gotoDaD) {
			dojo.byId('error-modal').className = "hide";
			// disable scroll bar for modal
			reloadScrollBars();

			if(gotoDaD){
				var clickEvent = document.createEvent ('MouseEvents');
				clickEvent.initEvent ('click', true, true);
				if(dojo.byId('UnselectedTabDespacho'))
					dojo.byId('UnselectedTabDespacho').dispatchEvent (clickEvent);
				if(dojo.query('.tablinks')[0])
					dojo.query('.tablinks')[0].dispatchEvent (clickEvent);
				
				// Reset the delivery option
				SinglePageCheckoutJS.selectedDeliveryOption = "";

			}
			
		},
		openPickupModal : function () {
			dojo.byId('error-modal').className = "ModalDesktop";
			// Enable scroll bar for modal
			unloadScrollBars();
		},
		/**
		 * This function is used to apply a promotion code to the order.
		 *
		 * @param {String} formName		The name of the promotion code entry form.
		 * @param {String} returnView	The name of the view that the server should redirect the browser to after a promotion code is applied.
		 */
		applyPromotionCode:function(formName,type) {
			var form = document.forms[formName];
			// Apply or Remove (A | R)
			form.taskType.value = type;
			
			if (trim(form.promoCode.value) == "") {
		    
				var promoErrMsg=MessageHelper.messages["PROMOTION_CODE_EMPTY"];
				dojo.byId('error_msg_promo').innerHTML = promoErrMsg;
				dojo.byId('error_msg_promo').style.display = 'block';		    	
				return;
			}
															
			service = wc.service.getServiceById('AjaxPromotionCodeManage');
			service.formId = formName;
			
			if (form.URL != null ){
				form.URL.value = "";
			}
                     
			//For handling multiple clicks
			if(!submitRequest()){
				return;
			}                      
			//cursor_wait();
			wc.service.invoke('AjaxPromotionCodeManage');

		},
		// This method to submit the giftcard form
		submitGiftCardForm: function (form) {
			if(validateGiftcardForm(form)) {
				var params = [];
				params.giftCardNumber = form.giftCardNumber.value;
				params.orderId = form.orderId.value;
				params.password = form.password.value;
				params.checkAction = "applyGiftCard";
				params.TRUT = formatRut(form.TRUT.value);
				
				// To avoid multiple click
				if(!submitRequest()){
					return;
				}
				//cursor_wait();				
				service = wc.service.getServiceById('AjaxGiftCardSection');
				service.formId = "GiftCardForm";
				
				// Open the progressBar
				openProgressBar();
				wc.service.invoke("AjaxGiftCardSection", params);
			}else{
				return false;
			}
				
		},
		
		// Method To open the novios search modal
		openNoviosModal: function(){
			// Refresh Step3: Novios Search Modal
			wc.render.updateContext("NoviosSearchFormModalContext",{"orderId":SinglePageCheckoutJS.orderId});
		},
		
		// Method to close novios search modal
		closeNoviosModal: function(){
			dojo.byId("NoviosSearchFormModal").className = "hide";
			//dojo.query("#NoviosSearchFormModal #checkoutNoviosddressForm")[0].classList.remove("ModalDesktop");
	        //dojo.query("#NoviosSearchFormModal #noviosAddressFormContainer").className = "modal-contenido";
	        //dojo.query("#NoviosSearchFormModal #imgCerrarNovios").classList.remove("CerrarIcono");
	        //dojo.query("#NoviosSearchFormModal #heading_closeNovios").classList('OcultaHeader');
	        //dojo.query("#NoviosSearchFormModal #checkout_novios_input_head").classList = ('OcultaHeader');	        	        
		},
		
		/**
		 * Saves the values submitted by the user in the Empressa modal.
		 * @param {string} Name of the Empressa form.
		 */
		saveFactura:function(facturaFormName) {
			var facturaForm = document.forms[facturaFormName];
			if(!isValidFacturaForm(facturaForm)) {
				return false;
			}
			var params = [];
			params.storeId = SinglePageCheckoutJS.storeId;
			params.catalogId = SinglePageCheckoutJS.catalogId;
			params.langId = SinglePageCheckoutJS.langId;
			params.organizationName = facturaForm.empresa.value;
			params.billingCode = formatRut(facturaForm.rut.value);
			params.officeAddress = facturaForm.razonsocial.value;
			params.address1 = facturaForm.direccion.value
			//params.address2 = facturaForm.address2.value;
			params.address3 = facturaForm.giro.value;
			params.state = facturaForm.state.value;
			params.city = facturaForm.city.value
			params.phone1 = facturaForm.telefono1.value;
			//params.phone2 = facturaForm.telefono2.value
			params.firstName = facturaForm.contacto.value;
			params.authToken = facturaForm.authToken.value;
			params.addressField2 = facturaForm.addressField2.value;
			params.addressType = "F";
			
			/* For Handling multiple clicks */
			if(!submitRequest()){
				return;
			}   	 	
		 	//cursor_wait();
			openProgressBar();
		 	wc.service.invoke("AjaxFacturaAdd", params);
		},
		
		// Update the selected facturaId to the current order
		updateFactura:function(addressId,isNewAddress) {			
			var params = [];
			params.storeId = SinglePageCheckoutJS.storeId;
			params.catalogId = SinglePageCheckoutJS.catalogId;
			params.langId = SinglePageCheckoutJS.langId;
			params.orderId = SinglePageCheckoutJS.orderId;
			params.facturaAddressId = addressId;
			
			/* For Handling multiple clicks */
			if(!submitRequest()){
				return;
			} 
			// If user select existing facutra address
			if(undefined == isNewAddress || null == isNewAddress){
				openProgressBar();
			}
		 	wc.service.invoke("AjaxCENOrderUpdateService", params);
		},
		
		// Delete the fatura association with the current order
		returnToBoleta:function() {			
			var params = [];
			params.storeId = SinglePageCheckoutJS.storeId;
			params.catalogId = SinglePageCheckoutJS.catalogId;
			params.langId = SinglePageCheckoutJS.langId;
			params.orderId = SinglePageCheckoutJS.orderId;
			
			/* For Handling multiple clicks */
			if(!submitRequest()){
				return;
			} 
			
			openProgressBar();
			
		 	wc.service.invoke("AjaxCENOrderUpdateService", params);
		},
		
		// To refresh the fatura form in billing section
		refreshFacturaForm:function(facturaSelectBox) {
			var addressId = "";
			if(facturaSelectBox.value != 'select') {
				addressId = facturaSelectBox.value;
			}
			//cursor_wait();
			wc.render.updateContext("FacturaFormModalAreaContext", {"orderId":SinglePageCheckoutJS.orderId,"selectedFacturaAddressId":addressId});
		},
		
		// To Open the fatura form as mmodal
		openFacturaFormaModal: function (edit){
			var params = [];
			params.orderId = SinglePageCheckoutJS.orderId;
			if(undefined != edit && null != edit
					&& dojo.byId('selectedFacturaAddressId')){
				params.selectedFacturaAddressId = dojo.byId('selectedFacturaAddressId').value;
			}				
			wc.render.updateContext("FacturaFormModalAreaContext", params);
		},
		// To close the fatura form as mmodal
		closeFaturaFormModal: function (){
			dojo.byId('ModalFactura').className = "";
			reloadScrollBars();
		},
		
		// Redirect the user to checkout login page (Only for guest)
		showCheckoutLogin: function (){
			wc.render.updateContext("guestCheckoutLogonAreaContext");
            AnchorScroll('#checkout_userdetails');

		}
		//Add or remove payment instruction for cybersource punchout.
		,createCBSTokenizationRequest: function(params){
			var fopId = params.fopId;
			var useDiscountAmount = "";
			var req = params;
			req.orderId = SinglePageCheckoutJS.orderId;
			req.langId = SinglePageCheckoutJS.langId
			req.storeId = SinglePageCheckoutJS.storeId
			req.catalogId = SinglePageCheckoutJS.catalogId
			req["authToken"] = dojo.byId('authToken_'+fopId).value; //TOken is needed to not to have CSRF error
			req["requesttype"] = "ajax";
			req["piAmount"]=dojo.byId('piAmount_'+fopId).value;
			req["card_issuerapp"]=dojo.byId('appId').value;//document.payment_form.installments.value;
			req["card_promoCodesUsed"]=dojo.byId('promoCode').value;//document.payment_form.installments.value;
			// If tc abierta then use cencosud price flag is ON.
			//req["useTCPrice"] = fopId==='20'?1:0;//useDiscountAmount;
			req["gift_card_used"]=dojo.byId('gift_card_used_'+fopId).value
			req["gift_card_number"]=dojo.byId('gift_card_number_'+fopId).value
			req["gift_card_password"]=dojo.byId('gift_card_password_'+fopId).value
			req["gift_card_pi_amount"]=dojo.byId('gift_card_pi_amount_'+fopId).value
			req["discount_amount"]=dojo.byId('discount_amount_'+fopId).value
			req["is_tc_pmethod"]=dojo.byId('is_tc_pmethod_'+fopId).value
			var useSavedToken=(dojo.byId('useSavedToken_'+fopId) !=null && dojo.byId('useSavedToken_'+fopId).value==='true');
			
			if(!useSavedToken){
				req["card_number"]=dojo.byId('card_number_'+fopId).value; //document.payment_form.card_number.value;
				req["card_type"]=dojo.byId('card_type_'+fopId).value; //document.payment_form.card_type.value;
				var expiryDate=dojo.byId('card_expiry_date_'+fopId).value; //document.payment_form.card_expiry_date.value;
				req["card_expiry_date"]=expiryDate;
				req["name_on_card"]=dojo.byId('name_on_card_'+fopId).value + '|'+  dojo.byId('lastname_on_card_'+fopId).value;
				req["bill_to_address_id"]=dojo.byId('bill_to_address_id_'+fopId).value;
				req["card_cvNumber"]=dojo.byId('card_cvNumber_'+fopId).value;//document.payment_form.card_cvc.value;
				req["installments"]=dojo.byId('installments_'+fopId).value;//document.payment_form.installments.value;
				if(dojo.byId('chkSaveCard_'+fopId)!=null){
					req["save_card_flag"]=dojo.byId('chkSaveCard_'+fopId).checked;//document.payment_form.installments.value;
					req["one_click_flag"]=(null != dojo.byId('chkActivateOneClick_'+fopId)) ? dojo.byId('chkActivateOneClick_'+fopId).checked : false;//document.payment_form.installments.value;
				}
			}else{
				req["useSavedToken"]=dojo.byId('useSavedToken_'+fopId).value;
				req["tokenToUse"]=dojo.byId('tokenToUse_'+fopId).value;
				req["tkn_billAddressId"]=dojo.byId('tkn_billAddressId_'+fopId).value;
				req["tkn_shipAddressId"]=dojo.byId('tkn_shipAddressId_'+fopId).value;
			}
			
			return req;						
		},	
		
		// Method to edit user details
		editUserDetails: function(){
			// Refresh:- Step1 - User information form (Billing Address) 
			wc.render.updateContext("userDetailsAreaContext",{"orderId":SinglePageCheckoutJS.orderId,"refreshBillingAddress":true});					
		    AnchorScroll("#checkout_userdetails");  
        },
		
		resetShippingDetails: function(){
			if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabDespacho'){
				resetNovios();
				resetReT();
				resetCE();
			}else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabRetiroEnTienda'){
				resetDaD();
				resetNovios();
				resetCE();
			}else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabNovio'){
				resetDaD();
				resetReT();
				resetCE();
			}else if(SinglePageCheckoutJS.selectedDeliveryOption == 'TabChileExpress'){
				resetNovios();
				resetDaD();
				resetReT();
			}
		},
		
		updateValidCCOrderItems: function(ioArgs){
			dojo.query('#mhtn_lista_productos_cc li').forEach(function(node){
				dojo.query('.invalidCCOrderItem', node).forEach(function(element){
					if(ioArgs.args != null && ioArgs.args.content != null && undefined != ioArgs.args.content.orderItemId
							&& null != ioArgs.args.content.orderItemId && element.value == ioArgs.args.content.orderItemId){
						dojo.destroy(node);						
					}	
				});
			});
			
			var tempNoOforderItems = dojo.byId('noOfOrderItems').value;
			dojo.byId('noOfOrderItems').value = parseInt(tempNoOforderItems) - 1;
			
			if(dojo.byId('validCCOrderItems')){
				if(ioArgs.args != null && ioArgs.args.content != null && undefined != ioArgs.args.content.orderItemId
						&& null != ioArgs.args.content.orderItemId){
					var deletedOrderItemId = ioArgs.args.content.orderItemId;
					var validCCOrderItems = dojo.byId('validCCOrderItems').value;
					var tempCCOrderItems = "";
					if(validCCOrderItems != ""){
						var ccOrderItemsArr = validCCOrderItems.split(",");
						for(var i=0; i < ccOrderItemsArr.length; i++){
							if(ccOrderItemsArr[i] != deletedOrderItemId){
								if(tempCCOrderItems == ""){
									tempCCOrderItems = ccOrderItemsArr[i];
								}else{
									tempCCOrderItems = tempCCOrderItems + "," + ccOrderItemsArr[i];
								}
							}
						}
						dojo.byId('validCCOrderItems').value = tempCCOrderItems;
						if(tempCCOrderItems == ""){
							var clickEvent = document.createEvent ('MouseEvents');
							clickEvent.initEvent ('click', true, true);
							if(dojo.byId('UnselectedTabDespacho'))
								dojo.byId('UnselectedTabDespacho').dispatchEvent (clickEvent);
							if(dojo.query('.tablinks')[0])
								dojo.query('.tablinks')[0].dispatchEvent (clickEvent);
							
							dojo.query('.tablinks')[1].style.display = "none !important";
							dojo.query('#UnselectedRetiro')[1].style.display = "none !important";
						}
					}
					 
				}
			}
			
		},
		setTokenToUse: function(tokenToUse,cardBillingAddressId,cardShippingAddressId,fopId){
            dojo.byId('cbspayment_'+fopId).style.display = "none";
 			dojo.byId('tokenToUse_'+fopId).value=tokenToUse;
			dojo.byId('useSavedToken_'+fopId).value='true';
			dojo.byId('tkn_billAddressId_'+fopId).value=cardBillingAddressId;
			dojo.byId('tkn_shipAddressId_'+fopId).value=cardShippingAddressId;
			
		}
						
}